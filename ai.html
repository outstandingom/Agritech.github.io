<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowSmart - Crop Recommendation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #2E8B57;
            --primary-light: #3CB371;
            --primary-dark: #228B22;
            --secondary: #4682B4;
            --accent: #FFA500;
            --warning: #FF6347;
            --error: #DC143C;
            --background: #F5F5F5;
            --surface: #FFFFFF;
            --text: #2F4F4F;
            --text-light: #708090;
            --border: #E0E0E0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.15);
            --radius: 16px;
            --gradient: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%);
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 16px;
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-title i {
            font-size: 22px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .location {
            font-size: 14px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Content Cards */
        .content-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary);
        }

        /* Status Card */
        .status-card {
            background: var(--gradient);
            color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .status-title {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .status-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .status-details {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Map Container */
        .map-container {
            margin-top: 15px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            height: 200px;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-nav {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }

        .map-nav-btn {
            background: var(--surface);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-nav-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Land Information */
        .land-info {
            margin-top: 15px;
        }

        .crop-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 15px;
        }

        .crop-detail-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .crop-detail-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .crop-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        /* Crop Recommendation */
        .crop-recommendation {
            margin-top: 20px;
            padding: 15px;
            background: rgba(70, 130, 180, 0.1);
            border-radius: 10px;
            display: none;
        }

        .recommendation-title {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-list {
            font-size: 14px;
            line-height: 1.5;
        }

        .recommendation-list li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .recommendation-list li:before {
            content: "•";
            color: var(--primary);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* Action Buttons */
        .action-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            margin-top: 15px;
        }

        .action-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            background: var(--border);
            color: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Display */
        .error-display {
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--error);
            border-radius: var(--radius);
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--error);
            font-weight: 600;
        }

        .error-details {
            font-size: 14px;
            color: var(--text);
            line-height: 1.5;
        }

        /* Bottom Navigation */
        .bottom-nav {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 480px;
            z-index: 1000;
            border: 1px solid var(--border);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 12px;
            text-decoration: none;
            color: inherit;
        }

        .nav-item.active {
            opacity: 1;
            color: var(--primary);
            background: rgba(46, 139, 87, 0.1);
        }

        .nav-item:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item span {
            font-size: 12px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            body {
                padding: 16px;
                padding-bottom: 100px;
            }
            
            .header {
                margin-bottom: 16px;
                padding: 10px 0;
            }
            
            .crop-details {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .bottom-nav {
                width: calc(100% - 32px);
                padding: 14px;
            }
            
            .nav-item span {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Error Display -->
        <div class="error-display" id="errorDisplay">
            <div class="error-header">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorTitle">Error Occurred</span>
            </div>
            <div class="error-details" id="errorDetails">
                An error occurred while processing your request.
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="app-title">
                <i class="fas fa-leaf"></i>
                GrowSmart
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText">Select a land</span>
                </div>
            </div>
        </div>

        <!-- Status Card -->
        <div class="status-card">
            <div class="status-title" id="statusTitle">Select Your Land</div>
            <div class="status-subtitle" id="statusSubtitle">Choose a land to get personalized crop recommendations</div>
            <div class="progress-container">
                <div class="progress-bar" id="statusProgress" style="width: 0%"></div>
            </div>
            <div class="status-details" id="statusDetails">Ready to analyze your land</div>
        </div>

        <!-- Land Selection -->
        <div class="content-card">
            <div class="section-title">
                <i class="fas fa-map-marked-alt"></i>
                Select Your Land
            </div>
            
            <div class="land-selector">
                <select class="form-select" id="landSelect">
                    <option value="">Loading lands...</option>
                </select>
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="map-nav">
                    <button class="map-nav-btn" id="prevLandBtn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="map-nav-btn" id="nextLandBtn" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="land-info">
                <div class="crop-details">
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Land Name</div>
                        <div class="crop-detail-value" id="selectedLand">No land selected</div>
                    </div>
                    
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Soil Type</div>
                        <div class="crop-detail-value" id="soilType">-</div>
                    </div>
                    
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Water Availability</div>
                        <div class="crop-detail-value" id="waterAvailability">-</div>
                    </div>
                    
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Area</div>
                        <div class="crop-detail-value" id="landArea">-</div>
                    </div>
                </div>
                
                <button class="action-btn" id="getRecommendationBtn" disabled>
                    <i class="fas fa-seedling"></i>
                    Get AI Crop Recommendations
                </button>
            </div>
        </div>

        <!-- Crop Recommendation -->
        <div class="content-card" id="recommendationCard" style="display: none;">
            <div class="section-title">
                <i class="fas fa-chart-line"></i>
                AI Crop Recommendations
            </div>
            
            <div class="crop-recommendation" id="cropRecommendation">
                <div class="recommendation-title">
                    <i class="fas fa-check-circle"></i>
                    Best Crops for Your Land
                </div>
                <ul class="recommendation-list" id="recommendationList">
                    <!-- Recommendations will be populated here -->
                </ul>
            </div>
            
            <div class="crop-details">
                <div class="crop-detail-item">
                    <div class="crop-detail-label">Best Match</div>
                    <div class="crop-detail-value" id="bestCrop">-</div>
                </div>
                
                <div class="crop-detail-item">
                    <div class="crop-detail-label">Season</div>
                    <div class="crop-detail-value" id="growingSeason">-</div>
                </div>
                
                <div class="crop-detail-item">
                    <div class="crop-detail-label">Yield Potential</div>
                    <div class="crop-detail-value" id="yieldPotential">-</div>
                </div>
                
                <div class="crop-detail-item">
                    <div class="crop-detail-label">Water Needs</div>
                    <div class="crop-detail-value" id="waterNeeds">-</div>
                </div>
            </div>
            
            <div class="crop-recommendation" style="margin-top: 15px;">
                <div class="recommendation-title">
                    <i class="fas fa-info-circle"></i>
                    Why These Crops?
                </div>
                <div class="recommendation-details" id="recommendationDetails">
                    <!-- Detailed explanation will be populated here -->
                </div>
            </div>
            
            <button class="action-btn" id="saveRecommendationBtn">
                <i class="fas fa-save"></i>
                Start Crop Journey
            </button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="soil.html" class="nav-item">
            <i class="fas fa-vial"></i>
            <span>Soil</span>
        </a>
        <a href="crops.html" class="nav-item">
            <i class="fas fa-seedling"></i>
            <span>Crops</span>
        </a>
        <a href="blockchain.html" class="nav-item">
            <i class="fas fa-link"></i>
            <span>Blockchain</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </div>

    <!-- Include external scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-checker.js"></script>

    <script>
        // Global variables
        let map;
        let currentUser = null;
        let userLands = [];
        let currentLandIndex = 0;
        let selectedLand = null;
        let cropRecommendations = null;

        // DOM Elements
        const errorDisplay = document.getElementById('errorDisplay');
        const errorTitle = document.getElementById('errorTitle');
        const errorDetails = document.getElementById('errorDetails');
        const userName = document.getElementById('userName');
        const locationText = document.getElementById('locationText');
        const statusTitle = document.getElementById('statusTitle');
        const statusSubtitle = document.getElementById('statusSubtitle');
        const statusProgress = document.getElementById('statusProgress');
        const statusDetails = document.getElementById('statusDetails');
        const landSelect = document.getElementById('landSelect');
        const selectedLandElement = document.getElementById('selectedLand');
        const soilType = document.getElementById('soilType');
        const waterAvailability = document.getElementById('waterAvailability');
        const landArea = document.getElementById('landArea');
        const prevLandBtn = document.getElementById('prevLandBtn');
        const nextLandBtn = document.getElementById('nextLandBtn');
        const getRecommendationBtn = document.getElementById('getRecommendationBtn');
        const recommendationCard = document.getElementById('recommendationCard');
        const cropRecommendation = document.getElementById('cropRecommendation');
        const recommendationList = document.getElementById('recommendationList');
        const recommendationDetails = document.getElementById('recommendationDetails');
        const bestCrop = document.getElementById('bestCrop');
        const growingSeason = document.getElementById('growingSeason');
        const yieldPotential = document.getElementById('yieldPotential');
        const waterNeeds = document.getElementById('waterNeeds');
        const saveRecommendationBtn = document.getElementById('saveRecommendationBtn');

        // Error Handling Functions
        function showError(title, message) {
            console.error(`Error: ${title}`, message);
            
            errorTitle.textContent = title;
            errorDetails.textContent = message;
            errorDisplay.style.display = 'block';
        }

        function hideError() {
            errorDisplay.style.display = 'none';
        }

        // Initialize map
        function initializeMap() {
            try {
                // Default to India center
                map = L.map('map').setView([22.7196, 75.8577], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            } catch (error) {
                showError('Map Initialization Failed', 'Failed to initialize the map. Please check your internet connection.');
            }
        }

        // Update map with land coordinates
        function updateMapWithLand(land) {
            try {
                // Clear existing layers
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polygon) {
                        map.removeLayer(layer);
                    }
                });

                if (land && land.coordinates && land.coordinates.length > 0) {
                    // Create polygon from coordinates
                    const polygon = L.polygon(land.coordinates, {
                        color: '#2E8B57',
                        fillColor: '#3CB371',
                        fillOpacity: 0.3,
                        weight: 3
                    }).addTo(map);
                    
                    // Fit map to the polygon bounds
                    map.fitBounds(polygon.getBounds());
                    
                    // Add marker at center
                    L.marker([land.center_lat, land.center_lng])
                        .addTo(map)
                        .bindPopup(`<b>${land.land_name}</b><br>${land.area_acres} acres`)
                        .openPopup();
                        
                    // Update location text
                    locationText.textContent = land.land_name;
                } else if (land && land.center_lat && land.center_lng) {
                    // If no polygon coordinates, just show center point
                    map.setView([land.center_lat, land.center_lng], 13);
                    L.marker([land.center_lat, land.center_lng])
                        .addTo(map)
                        .bindPopup(`<b>${land.land_name}</b><br>${land.area_acres} acres`)
                        .openPopup();
                        
                    // Update location text
                    locationText.textContent = land.land_name;
                }
            } catch (error) {
                console.error('Error updating map:', error);
                showError('Map Update Failed', 'Failed to update map with land coordinates.');
            }
        }

        // Load user data from Supabase
        async function loadUserData() {
            try {
                statusProgress.style.width = '30%';
                statusDetails.textContent = 'Loading user profile...';

                // Check authentication first
                const isAuthenticated = await window.authChecker.requireAuth();
                if (!isAuthenticated) {
                    showError('Authentication Required', 'Please log in to access this feature.');
                    return;
                }

                // Get current user
                currentUser = await window.authChecker.getCurrentUser();
                if (!currentUser) {
                    showError('User Not Found', 'No authenticated user found. Please log in again.');
                    return;
                }

                statusProgress.style.width = '50%';
                statusDetails.textContent = 'Loading user profile...';

                // Load user profile
                const { data: userProfile, error: userError } = await window.supabaseClient
                    .from('users')
                    .select('*')
                    .eq('auth_id', currentUser.id)
                    .single();
                
                if (userError) {
                    showError('Profile Load Failed', 'Failed to load user profile from database.', userError);
                } else if (userProfile) {
                    userName.textContent = userProfile.full_name;
                }

                statusProgress.style.width = '70%';
                statusDetails.textContent = 'Loading your lands...';

                // Load user lands
                const { data: lands, error: landsError } = await window.supabaseClient
                    .from('lands')
                    .select('*')
                    .eq('auth_id', currentUser.id);
                
                if (landsError) {
                    showError('Lands Load Failed', 'Failed to load user lands from database.', landsError);
                } else if (lands && lands.length > 0) {
                    userLands = lands;
                    
                    statusProgress.style.width = '90%';
                    statusDetails.textContent = 'Loading land coordinates...';

                    // Load coordinates for each land
                    for (let land of userLands) {
                        try {
                            const { data: coordinates, error: coordsError } = await window.supabaseClient
                                .from('land_coordinates')
                                .select('latitude, longitude, corner_index')
                                .eq('land_id', land.land_id)
                                .order('corner_index');
                            
                            if (!coordsError && coordinates && coordinates.length > 0) {
                                land.coordinates = coordinates.map(coord => [coord.latitude, coord.longitude]);
                            }
                        } catch (error) {
                            console.error('Error loading coordinates:', error);
                        }
                    }
                    
                    // Populate land dropdown
                    populateLandDropdown();
                    updateLandDisplay();
                    
                    statusProgress.style.width = '100%';
                    statusDetails.textContent = 'Ready! Select a land to get recommendations';
                    statusTitle.textContent = 'Land Loaded Successfully';
                    statusSubtitle.textContent = `${userLands.length} lands found`;

                } else {
                    selectedLandElement.textContent = 'No lands found';
                    prevLandBtn.disabled = true;
                    nextLandBtn.disabled = true;
                    landSelect.innerHTML = '<option value="">No lands available</option>';
                    
                    statusProgress.style.width = '100%';
                    statusDetails.textContent = 'No lands found. Please add a land first.';
                    statusTitle.textContent = 'No Lands Available';
                    statusSubtitle.textContent = 'Add a land to get started';
                }

            } catch (error) {
                showError('User Data Load Failed', 'Failed to load user data. Please refresh the page.', error);
            }
        }

        // Populate land dropdown
        function populateLandDropdown() {
            landSelect.innerHTML = '';
            
            userLands.forEach((land, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${land.land_name} (${land.area_acres} acres)`;
                landSelect.appendChild(option);
            });
            
            if (userLands.length > 0) {
                landSelect.value = currentLandIndex;
            }
        }

        // Update land display
        function updateLandDisplay() {
            if (userLands.length === 0) {
                selectedLandElement.textContent = 'No lands found';
                soilType.textContent = '-';
                waterAvailability.textContent = '-';
                landArea.textContent = '-';
                prevLandBtn.disabled = true;
                nextLandBtn.disabled = true;
                getRecommendationBtn.disabled = true;
                return;
            }
            
            const currentLand = userLands[currentLandIndex];
            selectedLand = currentLand;
            
            selectedLandElement.textContent = currentLand.land_name;
            soilType.textContent = currentLand.soil_type || 'Not specified';
            waterAvailability.textContent = currentLand.water_availability || 'Not specified';
            landArea.textContent = currentLand.area_acres ? `${currentLand.area_acres} acres` : 'Not specified';
            
            // Update map
            updateMapWithLand(currentLand);
            
            // Update navigation buttons
            prevLandBtn.disabled = currentLandIndex === 0;
            nextLandBtn.disabled = currentLandIndex === userLands.length - 1;
            
            // Update dropdown selection
            landSelect.value = currentLandIndex;
            
            // Enable recommendation button
            getRecommendationBtn.disabled = false;
        }

        // Get crop recommendations based on selected land
        async function getCropRecommendations() {
            if (!selectedLand) {
                showError('No Land Selected', 'Please select a land first.');
                return;
            }
            
            try {
                // Show loading state
                getRecommendationBtn.innerHTML = '<span class="spinner"></span> Analyzing your land with AI...';
                getRecommendationBtn.disabled = true;
                
                // Get additional data for better recommendations
                const soilAnalysis = await getSoilAnalysis(selectedLand.land_id);
                const weatherData = await getWeatherData(selectedLand.land_id);
                
                // Prepare request data for Gemini API
                const requestData = {
                    land: {
                        name: selectedLand.land_name,
                        soilType: selectedLand.soil_type,
                        waterAvailability: selectedLand.water_availability,
                        area: selectedLand.area_acres,
                        coordinates: {
                            lat: selectedLand.center_lat,
                            lng: selectedLand.center_lng
                        }
                    },
                    soilAnalysis: soilAnalysis,
                    weatherData: weatherData
                };
                
                // Call Gemini API for crop recommendations
                const recommendations = await callGeminiAPI(requestData);
                
                // Process and display recommendations
                displayCropRecommendations(recommendations);
                
                // Reset button state
                getRecommendationBtn.innerHTML = '<i class="fas fa-seedling"></i> Get AI Crop Recommendations';
                getRecommendationBtn.disabled = false;
                
            } catch (error) {
                showError('Recommendation Failed', 'Failed to get crop recommendations. Please try again.');
                console.error('Error getting recommendations:', error);
                
                // Reset button state
                getRecommendationBtn.innerHTML = '<i class="fas fa-seedling"></i> Get AI Crop Recommendations';
                getRecommendationBtn.disabled = false;
            }
        }

        // Get soil analysis data
        async function getSoilAnalysis(landId) {
            try {
                const { data, error } = await window.supabaseClient
                    .from('soil_analysis')
                    .select('*')
                    .eq('land_id', landId)
                    .order('analysis_date', { ascending: false })
                    .limit(1);
                
                if (!error && data && data.length > 0) {
                    return data[0];
                }
                return null;
            } catch (error) {
                console.error('Error getting soil analysis:', error);
                return null;
            }
        }

        // Get weather data
        async function getWeatherData(landId) {
            try {
                const { data, error } = await window.supabaseClient
                    .from('weather_reports')
                    .select('*')
                    .eq('land_id', landId)
                    .order('report_date', { ascending: false })
                    .limit(1);
                
                if (!error && data && data.length > 0) {
                    return data[0];
                }
                return null;
            } catch (error) {
                console.error('Error getting weather data:', error);
                return null;
            }
        }

        // Call Gemini API for crop recommendations
        async function callGeminiAPI(requestData) {
            const API_KEY = 'AIzaSyD-qhnQlGDMd2BcoZo-hv5ld2fbDzP49sI';
            const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
            
            // Prepare the prompt for Gemini
            const prompt = `
                As an agricultural expert, analyze this land data and provide crop recommendations:
                
                LAND INFORMATION:
                - Name: ${requestData.land.name}
                - Soil Type: ${requestData.land.soilType}
                - Water Availability: ${requestData.land.waterAvailability}
                - Area: ${requestData.land.area} acres
                - Location: Latitude ${requestData.land.coordinates.lat}, Longitude ${requestData.land.coordinates.lng}
                
                ${requestData.soilAnalysis ? `
                SOIL ANALYSIS:
                - pH Level: ${requestData.soilAnalysis.ph_level}
                - Nitrogen: ${requestData.soilAnalysis.nitrogen}
                - Phosphorus: ${requestData.soilAnalysis.phosphorus}
                - Potassium: ${requestData.soilAnalysis.potassium}
                - Organic Matter: ${requestData.soilAnalysis.organic_matter}%
                ` : 'No recent soil analysis available'}
                
                ${requestData.weatherData ? `
                WEATHER CONDITIONS:
                - Temperature: ${requestData.weatherData.current_temperature}°C
                - Rainfall: ${requestData.weatherData.rainfall_amount} mm
                - Humidity: ${requestData.weatherData.humidity}%
                ` : 'No recent weather data available'}
                
                Please provide:
                1. Top 3-5 recommended crops for this specific land
                2. For each crop, include suitability score, growing season, yield potential, and water requirements
                3. Detailed explanation of why these crops are recommended
                4. Specific agricultural practices for this land
                5. Potential challenges and solutions
                
                Format the response as a JSON object with this structure:
                {
                    "bestCrops": [
                        {
                            "name": "Crop Name",
                            "suitability": 9,
                            "season": "Rabi/Kharif/Zaid",
                            "yield": "High/Medium/Low",
                            "water": "High/Medium/Low",
                            "advantages": ["Advantage 1", "Advantage 2"]
                        }
                    ],
                    "explanation": "Detailed explanation here",
                    "practices": ["Practice 1", "Practice 2"],
                    "challenges": ["Challenge 1 with solution", "Challenge 2 with solution"]
                }
            `;
            
            const requestBody = {
                contents: [
                    {
                        parts: [
                            {
                                text: prompt
                            }
                        ]
                    }
                ],
                generationConfig: {
                    temperature: 0.2,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 1024,
                }
            };
            
            try {
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                // Extract the text from the response
                const responseText = data.candidates[0].content.parts[0].text;
                
                // Try to parse the JSON from the response
                try {
                    // Extract JSON from the response (in case there's additional text)
                    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    } else {
                        // Fallback: create a structured response from the text
                        return createStructuredResponse(responseText, requestData);
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    // Fallback: create a structured response from the text
                    return createStructuredResponse(responseText, requestData);
                }
                
            } catch (error) {
                console.error('API call failed:', error);
                // Return fallback recommendations based on land data
                return getFallbackRecommendations(requestData);
            }
        }

        // Create structured response from text (fallback)
        function createStructuredResponse(text, requestData) {
            // Simple fallback parsing
            const crops = [];
            const lines = text.split('\n');
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                
                if (trimmedLine && /^\d+\./.test(trimmedLine)) {
                    const cropName = trimmedLine.replace(/^\d+\.\s*/, '').split(':')[0];
                    if (cropName && cropName.length < 50) { // Basic validation
                        crops.push({
                            name: cropName,
                            suitability: 8,
                            season: getSeasonFromSoil(requestData.land.soilType),
                            yield: 'Good',
                            water: requestData.land.waterAvailability === 'high' ? 'Medium' : 'Low',
                            advantages: ['Well-suited to your soil type', 'Good market potential']
                        });
                    }
                }
                
                if (crops.length >= 3) break;
            }
            
            return {
                bestCrops: crops.length > 0 ? crops : getFallbackRecommendations(requestData).bestCrops,
                explanation: "Based on your land characteristics, these crops are recommended for optimal yield and sustainability.",
                practices: ["Test soil pH before planting", "Implement proper irrigation scheduling"],
                challenges: ["Monitor for pest outbreaks - use integrated pest management", "Manage water efficiently - consider drip irrigation"]
            };
        }

        // Helper function to determine season from soil type
        function getSeasonFromSoil(soilType) {
            const soilSeasonMap = {
                'sandy': 'Kharif',
                'loamy': 'Rabi/Kharif',
                'clay': 'Kharif',
                'silt': 'Rabi',
                'peaty': 'Kharif',
                'chalky': 'Rabi'
            };
            return soilSeasonMap[soilType] || 'Rabi/Kharif';
        }

        // Fallback recommendations if API fails
        function getFallbackRecommendations(requestData) {
            // Simple fallback based on soil type and water availability
            const soilBasedCrops = {
                sandy: ['Pearl Millet', 'Groundnut', 'Watermelon'],
                loamy: ['Wheat', 'Maize', 'Soybean', 'Cotton'],
                clay: ['Rice', 'Sugarcane', 'Lentils', 'Chickpea'],
                silt: ['Wheat', 'Barley', 'Oats', 'Potato'],
                peaty: ['Rice', 'Cabbage', 'Celery', 'Onions'],
                chalky: ['Spinach', 'Beets', 'Sweet Corn', 'Cabbage']
            };
            
            const crops = soilBasedCrops[requestData.land.soilType] || ['Wheat', 'Maize', 'Rice'];
            
            return {
                bestCrops: crops.map((crop, index) => ({
                    name: crop,
                    suitability: 9 - index,
                    season: getSeasonFromSoil(requestData.land.soilType),
                    yield: 'High with proper management',
                    water: requestData.land.waterAvailability === 'high' ? 'Medium' : 'Low',
                    advantages: ['Well-suited to your soil type', 'Good market demand']
                })),
                explanation: `Based on your ${requestData.land.soilType} soil and ${requestData.land.waterAvailability} water availability, these crops are traditionally successful in your region.`,
                practices: ['Consult with local agricultural experts for specific varieties', 'Test soil pH before planting'],
                challenges: ['Monitor water usage carefully', 'Check for local pest advisories']
            };
        }

        // Display crop recommendations
        function displayCropRecommendations(recommendations) {
            cropRecommendations = recommendations;
            
            // Clear previous recommendations
            recommendationList.innerHTML = '';
            
            // Add crops to recommendation list
            recommendations.bestCrops.forEach((crop, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${crop.name}</strong> - Suitability: ${crop.suitability}/10 - Season: ${crop.season}`;
                recommendationList.appendChild(li);
            });
            
            // Update crop details
            if (recommendations.bestCrops.length > 0) {
                const bestCropData = recommendations.bestCrops[0];
                bestCrop.textContent = bestCropData.name;
                growingSeason.textContent = bestCropData.season;
                yieldPotential.textContent = bestCropData.yield;
                waterNeeds.textContent = bestCropData.water;
            }
            
            // Update explanation and details
            recommendationDetails.innerHTML = `
                <p>${recommendations.explanation}</p>
                ${recommendations.practices ? `
                <p style="margin-top: 10px;"><strong>Recommended Practices:</strong></p>
                <ul>
                    ${recommendations.practices.map(practice => `<li>${practice}</li>`).join('')}
                </ul>
                ` : ''}
                ${recommendations.challenges ? `
                <p style="margin-top: 10px;"><strong>Potential Challenges & Solutions:</strong></p>
                <ul>
                    ${recommendations.challenges.map(challenge => `<li>${challenge}</li>`).join('')}
                </ul>
                ` : ''}
            `;
            
            // Show recommendation card
            recommendationCard.style.display = 'block';
            cropRecommendation.style.display = 'block';
            
            // Scroll to recommendations
            recommendationCard.scrollIntoView({ behavior: 'smooth' });
        }

        // Save recommendation and start crop journey
        async function saveRecommendation() {
            if (!cropRecommendations || !selectedLand) return;
            
            try {
                saveRecommendationBtn.innerHTML = '<span class="spinner"></span> Creating crop...';
                saveRecommendationBtn.disabled = true;
                
                const bestCropName = cropRecommendations.bestCrops[0].name;
                
                // Create a new crop in the database
                const cropId = 'CROP_' + Date.now();
                const plantingDate = new Date().toISOString().split('T')[0];
                
                // Calculate expected harvest date (add default duration)
                const harvestDate = new Date();
                harvestDate.setDate(harvestDate.getDate() + 120);
                const expectedHarvestDate = harvestDate.toISOString().split('T')[0];
                
                // Insert crop into database
                const { data: crop, error } = await window.supabaseClient
                    .from('crops')
                    .insert({
                        crop_id: cropId,
                        auth_id: currentUser.id,
                        land_id: selectedLand.land_id,
                        crop_name: bestCropName,
                        crop_type: 'custom',
                        planting_date: plantingDate,
                        expected_harvest_date: expectedHarvestDate,
                        area_allocated: selectedLand.area_acres,
                        current_stage: 'germination',
                        is_active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) {
                    throw new Error('Failed to create crop: ' + error.message);
                }
                
                // Create initial crop stages
                const stages = ['germination', 'seedling', 'vegetative', 'flowering', 'fruiting', 'maturity'];
                
                for (let i = 0; i < stages.length; i++) {
                    const stageKey = stages[i];
                    await window.supabaseClient
                        .from('crop_stages')
                        .insert({
                            crop_id: cropId,
                            auth_id: currentUser.id,
                            stage_key: stageKey,
                            stage_name: stageKey.charAt(0).toUpperCase() + stageKey.slice(1),
                            stage_order: i,
                            ai_verified_conditions: [],
                            is_current: i === 0,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                }
                
                showNotification(`Crop journey started for ${bestCropName}!`);
                
                // Redirect to crop management page after a delay
                setTimeout(() => {
                    window.location.href = 'crops.html';
                }, 2000);
                
            } catch (error) {
                showError('Crop Creation Failed', 'Failed to start crop journey. Please try again.');
                console.error('Error saving recommendation:', error);
                
                saveRecommendationBtn.innerHTML = '<i class="fas fa-save"></i> Start Crop Journey';
                saveRecommendationBtn.disabled = false;
            }
        }

        // Show notification
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow-hover);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Event Listeners
        function setupEventListeners() {
            // Land selection dropdown
            landSelect.addEventListener('change', (e) => {
                const selectedIndex = parseInt(e.target.value);
                if (!isNaN(selectedIndex) && selectedIndex >= 0 && selectedIndex < userLands.length) {
                    currentLandIndex = selectedIndex;
                    updateLandDisplay();
                }
            });

            // Land navigation
            prevLandBtn.addEventListener('click', () => {
                if (currentLandIndex > 0) {
                    currentLandIndex--;
                    updateLandDisplay();
                }
            });

            nextLandBtn.addEventListener('click', () => {
                if (currentLandIndex < userLands.length - 1) {
                    currentLandIndex++;
                    updateLandDisplay();
                }
            });

            // Buttons
            getRecommendationBtn.addEventListener('click', getCropRecommendations);
            saveRecommendationBtn.addEventListener('click', saveRecommendation);

            // Error display close
            errorDisplay.addEventListener('click', hideError);
        }

        // Initialize the application
        async function initApp() {
            try {
                // Set up event listeners
                setupEventListeners();
                
                // Initialize map
                initializeMap();
                
                // Load user data
                await loadUserData();
                
            } catch (error) {
                showError('App Initialization Failed', 'Failed to initialize the application.');
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
