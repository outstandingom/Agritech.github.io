<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growhaz - Multi-Land Mapping</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Your existing CSS styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(to right, #2e7d32, #4caf50);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
        }
        
        .app-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .app-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .user-info {
            position: absolute;
            top: 15px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .logout-btn, .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover, .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .header-controls {
            position: absolute;
            top: 15px;
            left: 20px;
            display: flex;
            gap: 10px;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .section {
            flex: 1;
            min-width: 300px;
            padding: 20px;
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #2e7d32;
            border-bottom: 2px solid #e8f5e9;
            padding-bottom: 10px;
        }
        
        .map-container {
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        #map {
            height: 400px;
            width: 100%;
        }
        
        .land-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .land-btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .land-btn.primary {
            background: #2e7d32;
            color: white;
        }
        
        .land-btn.secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .land-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        .land-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .speech-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .land-btn.speaking .speech-indicator {
            opacity: 1;
        }
        
        .status-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .status-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .status-label {
            font-weight: 600;
            width: 120px;
            color: #2e7d32;
        }
        
        .status-value {
            flex: 1;
        }
        
        .coordinates-list {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .coordinate-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
        }
        
        .coordinate-item:last-child {
            border-bottom: none;
        }
        
        .lands-container {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .lands-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .lands-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2e7d32;
        }
        
        .lands-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .land-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #4caf50;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .land-item:hover {
            background: #e8f5e9;
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .land-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .land-title {
            font-weight: 600;
            color: #2e7d32;
        }
        
        .land-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        .total-area {
            background: #2e7d32;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        
        .total-area-value {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .location-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        /* Land Details Form */
        .land-form {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .land-form.active {
            display: block;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2e7d32;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .save-land-btn, .cancel-land-btn {
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            transition: all 0.3s ease;
            position: relative;
        }

        .save-land-btn {
            background: #2e7d32;
            color: white;
        }

        .cancel-land-btn {
            background: #6c757d;
            color: white;
        }

        .save-land-btn:hover, .cancel-land-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        /* Land Details Modal */
        .land-details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .land-details-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 25px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .land-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .land-details-map {
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
        }

        .coordinates-details {
            grid-column: 1 / -1;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .coordinates-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .coordinates-table th,
        .coordinates-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .coordinates-table th {
            background: #e8f5e9;
            color: #2e7d32;
            font-weight: 600;
        }

        /* Land Overview Map */
        .lands-overview-map {
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 15px;
            border: 2px solid #e8f5e9;
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loader-small {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .section {
                min-width: 100%;
            }
            
            .land-controls {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .land-details-grid {
                grid-template-columns: 1fr;
            }

            .land-details-content {
                width: 95%;
                padding: 15px;
            }

            .user-info {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }

            .header-controls {
                position: static;
                justify-content: center;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <button class="back-btn" id="backToProfile">
                    <i class="fas fa-arrow-left"></i> Profile
                </button>
            </div>
            <div class="app-name">Growhaz</div>
            <div class="app-subtitle">Multi-Land Mapping & Management</div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <div class="content">
            <!-- Land Mapping Section -->
            <div class="section">
                <h2 class="section-title" id="mappingTitle">Land Mapping</h2>
                
                <!-- Location Error Message -->
                <div id="locationError" class="location-error" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="locationErrorText">Location error occurred</span>
                </div>
                
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <div class="land-controls">
                    <button id="startTracking" class="land-btn primary">
                        <i class="fas fa-play"></i> <span id="startTrackingText">Start Tracking</span>
                        <div class="speech-indicator">
                            <i class="fas fa-volume-up"></i>
                        </div>
                    </button>
                    <button id="stopTracking" class="land-btn secondary" disabled>
                        <i class="fas fa-stop"></i> <span id="stopTrackingText">Stop Tracking</span>
                        <div class="speech-indicator">
                            <i class="fas fa-volume-up"></i>
                        </div>
                    </button>
                    <button id="addCorner" class="land-btn primary" disabled>
                        <i class="fas fa-plus"></i> <span id="addCornerText">Add Corner</span>
                        <div class="speech-indicator">
                            <i class="fas fa-volume-up"></i>
                        </div>
                    </button>
                    <button id="finishLand" class="land-btn primary" disabled>
                        <i class="fas fa-check"></i> <span id="finishLandText">Finish Land</span>
                        <div class="speech-indicator">
                            <i class="fas fa-volume-up"></i>
                        </div>
                    </button>
                    <button id="resetAll" class="land-btn secondary">
                        <i class="fas fa-redo"></i> <span id="resetAllText">Reset All</span>
                        <div class="speech-indicator">
                            <i class="fas fa-volume-up"></i>
                        </div>
                    </button>
                </div>
                
                <div class="status-info">
                    <div class="status-row">
                        <span class="status-label" id="statusLabel">Status:</span>
                        <span class="status-value" id="status">Ready to start</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label" id="locationLabel">Current Location:</span>
                        <span class="status-value" id="coords">—</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label" id="accuracyLabel">Accuracy:</span>
                        <span class="status-value" id="accuracy">—</span>
                    </div>
                </div>
                
                <div class="coordinates-list">
                    <h3 style="margin-bottom: 10px; color: #2e7d32;" id="cornersTitle">Current Land Corners</h3>
                    <ul id="cornerList">
                        <li style="text-align: center; color: #999; padding: 20px;" id="noCornersText">No corners added yet</li>
                    </ul>
                </div>

                <!-- Land Information Form -->
                <div id="landForm" class="land-form">
                    <h3 style="color: #2e7d32; margin-bottom: 20px;" id="landInfoTitle">Land Information</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" id="landNameLabel">Land Name *</label>
                            <input type="text" id="landName" class="form-input" placeholder="Enter land name" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" id="soilTypeLabel">Soil Type *</label>
                            <select id="soilType" class="form-select" required>
                                <option value="">Select Soil Type</option>
                                <option value="sandy">Sandy Soil</option>
                                <option value="clay">Clay Soil</option>
                                <option value="loamy">Loamy Soil</option>
                                <option value="silt">Silt Soil</option>
                                <option value="peaty">Peaty Soil</option>
                                <option value="chalky">Chalky Soil</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" id="waterLabel">Water Availability *</label>
                            <select id="waterAvailability" class="form-select" required>
                                <option value="">Select Water Availability</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="moderate">Moderate</option>
                                <option value="poor">Poor</option>
                                <option value="seasonal">Seasonal</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" id="cropsLabel">Current Crops</label>
                            <input type="text" id="currentCrops" class="form-input" placeholder="Enter current crops">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="landUseLabel">Land Use</label>
                        <select id="landUse" class="form-select">
                            <option value="">Select Land Use</option>
                            <option value="agriculture">Agriculture</option>
                            <option value="orchard">Orchard</option>
                            <option value="pasture">Pasture</option>
                            <option value="mixed">Mixed Use</option>
                            <option value="fallow">Fallow Land</option>
                        </select>
                    </div>
                    
                    <div class="form-actions">
                        <button id="saveLand" class="save-land-btn">
                            <i class="fas fa-save"></i> <span id="saveLandText">Save Land</span>
                        </button>
                        <button id="cancelLand" class="cancel-land-btn">
                            <i class="fas fa-times"></i> <span id="cancelLandText">Cancel</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Lands Overview Section -->
            <div class="section">
                <h2 class="section-title" id="overviewTitle">Lands Overview</h2>
                
                <div class="lands-container">
                    <div class="lands-header">
                        <h3 class="lands-title" id="yourLandsTitle">Your Farm Lands</h3>
                        <span class="land-count" id="landCount">0 lands</span>
                    </div>
                    
                    <!-- Lands Overview Map -->
                    <div class="lands-overview-map-container">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;" id="overviewMapTitle">All Lands Overview</h4>
                        <div id="landsOverviewMap" class="lands-overview-map"></div>
                    </div>
                    
                    <div class="lands-list" id="landsList">
                        <div style="text-align: center; color: #999; padding: 40px;">
                            <i class="fas fa-tractor" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p id="noLandsText">No lands mapped yet. Start tracking and add corners to create your first land.</p>
                        </div>
                    </div>
                    
                    <div class="total-area">
                        <div id="totalAreaTitle">Total Farm Area</div>
                        <div class="total-area-value" id="totalArea">—</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Land Details Modal -->
    <div id="landDetailsModal" class="land-details-modal">
        <div class="land-details-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <h2 id="modalLandTitle" style="color: #2e7d32; margin-bottom: 20px;">Land Details</h2>
            
            <div class="land-details-grid">
                <!-- Land Map -->
                <div class="land-details-map-container">
                    <h4 style="margin-bottom: 10px; color: #2e7d32;" id="landMapTitle">Land Map View</h4>
                    <div id="landDetailsMap" class="land-details-map"></div>
                </div>
                
                <!-- Land Information -->
                <div style="background: #f9f9f9; padding: 20px; border-radius: 10px;">
                    <h4 style="margin-bottom: 15px; color: #2e7d32;" id="landInfoDetailsTitle">Land Information</h4>
                    <div id="landInfoDetails">
                        <!-- Land information will be displayed here -->
                    </div>
                </div>
                
                <!-- Coordinates Details -->
                <div class="coordinates-details">
                    <h4 style="margin-bottom: 10px; color: #2e7d32;" id="coordinatesTitle">Land Coordinates</h4>
                    <table class="coordinates-table" id="coordinatesTable">
                        <thead>
                            <tr>
                                <th id="cornerHeader">Corner</th>
                                <th id="latitudeHeader">Latitude</th>
                                <th id="longitudeHeader">Longitude</th>
                                <th id="distanceHeader">Distance from Start</th>
                            </tr>
                        </thead>
                        <tbody id="coordinatesTableBody">
                            <!-- Coordinates will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <a href="index.html" class="nav-item">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </a>
            <a href="soil.html" class="nav-item">
                <i class="fas fa-vial"></i>
                <span>Soil</span>
            </a>
            <a href="crops.html" class="nav-item">
                <i class="fas fa-seedling"></i>
                <span>Crops</span>
            </a>
            <a href="blockchain.html" class="nav-item">
                <i class="fas fa-link"></i>
                <span>Blockchain</span>
            </a>
            <a href="profile.html" class="nav-item active">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </div>
    </div>

    <!-- Include external scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>

    <script>
        // Global variables
        let map, landsOverviewMap, landDetailsMap;
        let watchId = null;
        let currentPosMarker = null;
        let currentCoords = null;
        let locationAccuracy = null;
        let currentCorners = [];
        let allLands = [];
        let drawnLayers = [];
        let overviewLayers = [];
        let selectedLandIndex = null;
        let currentLanguage = 'English';
        let speechEnabled = false;
        let currentUserProfile = null;

        // DOM elements
        const startTrackingBtn = document.getElementById('startTracking');
        const stopTrackingBtn = document.getElementById('stopTracking');
        const addCornerBtn = document.getElementById('addCorner');
        const finishLandBtn = document.getElementById('finishLand');
        const resetAllBtn = document.getElementById('resetAll');
        const backToProfileBtn = document.getElementById('backToProfile');
        const statusElement = document.getElementById('status');
        const coordsElement = document.getElementById('coords');
        const accuracyElement = document.getElementById('accuracy');
        const locationErrorElement = document.getElementById('locationError');
        const locationErrorText = document.getElementById('locationErrorText');
        const logoutBtn = document.getElementById('logoutBtn');
        const userAvatar = document.getElementById('userAvatar');
        
        // Form elements
        const landForm = document.getElementById('landForm');
        const landNameInput = document.getElementById('landName');
        const soilTypeInput = document.getElementById('soilType');
        const waterAvailabilityInput = document.getElementById('waterAvailability');
        const currentCropsInput = document.getElementById('currentCrops');
        const landUseInput = document.getElementById('landUse');
        const saveLandBtn = document.getElementById('saveLand');
        const cancelLandBtn = document.getElementById('cancelLand');
        
        // Modal elements
        const landDetailsModal = document.getElementById('landDetailsModal');
        const closeModalBtn = document.getElementById('closeModal');
        const modalLandTitle = document.getElementById('modalLandTitle');
        const landDetailsMapElement = document.getElementById('landDetailsMap');
        const landInfoDetails = document.getElementById('landInfoDetails');
        const coordinatesTableBody = document.getElementById('coordinatesTableBody');

        // Auth checker functions
        const authChecker = {
            async requireAuth() {
                try {
                    const { data: { session }, error } = await window.supabaseClient.auth.getSession();
                    if (!session || error) {
                        window.location.href = 'login.html';
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('Auth check error:', error);
                    window.location.href = 'login.html';
                    return false;
                }
            },
            
            async getCurrentUser() {
                try {
                    const { data: { user }, error } = await window.supabaseClient.auth.getUser();
                    if (error || !user) {
                        return null;
                    }
                    return user;
                } catch (error) {
                    console.error('Error getting user:', error);
                    return null;
                }
            },
            
            async getUserId() {
                const user = await this.getCurrentUser();
                return user ? user.id : null;
            },
            
            async signOut() {
                try {
                    const { error } = await window.supabaseClient.auth.signOut();
                    if (error) {
                        console.error('Error signing out:', error);
                        return false;
                    }
                    return true;
                } catch (error) {
                    console.error('Sign out error:', error);
                    return false;
                }
            }
        };

        // User profile functions
        const userProfile = {
            async getOrCreateUserProfile() {
                try {
                    const user = await authChecker.getCurrentUser();
                    if (!user) {
                        throw new Error('No authenticated user');
                    }

                    // First, try to get the user profile
                    const { data: existingProfile, error: fetchError } = await window.supabaseClient
                        .from('users')
                        .select('*')
                        .eq('auth_id', user.id)
                        .single();

                    if (fetchError && fetchError.code === 'PGRST116') {
                        // Profile doesn't exist, create one
                        console.log('Creating new user profile...');
                        
                        // Generate a user_id (you can customize this logic)
                        const userId = `USER${Date.now()}${Math.random().toString(36).substring(2, 8)}`.toUpperCase();
                        
                        const { data: newProfile, error: createError } = await window.supabaseClient
                            .from('users')
                            .insert([{
                                user_id: userId,
                                auth_id: user.id,
                                full_name: user.user_metadata?.full_name || 'User',
                                phone: user.user_metadata?.phone || '',
                                email: user.email,
                                language: 'English',
                                role: 'farmer'
                            }])
                            .select()
                            .single();

                        if (createError) {
                            throw new Error(`Failed to create user profile: ${createError.message}`);
                        }

                        console.log('User profile created successfully:', newProfile);
                        return newProfile;
                    } else if (fetchError) {
                        throw new Error(`Failed to fetch user profile: ${fetchError.message}`);
                    }

                    console.log('User profile found:', existingProfile);
                    return existingProfile;
                } catch (error) {
                    console.error('Error in getOrCreateUserProfile:', error);
                    throw error;
                }
            },

            async getUserProfile() {
                try {
                    const user = await authChecker.getCurrentUser();
                    if (!user) return null;

                    const { data: profile, error } = await window.supabaseClient
                        .from('users')
                        .select('*')
                        .eq('auth_id', user.id)
                        .single();

                    if (error) {
                        console.error('Error getting user profile:', error);
                        return null;
                    }

                    return profile;
                } catch (error) {
                    console.error('Error in getUserProfile:', error);
                    return null;
                }
            }
        };

        // Initialize maps
        function initializeMaps() {
            // Initialize main map
            map = L.map('map').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Initialize lands overview map
            landsOverviewMap = L.map('landsOverviewMap').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(landsOverviewMap);
        }

        // Generate unique land ID
        function generateLandId() {
            const timestamp = Date.now().toString(36);
            const randomStr = Math.random().toString(36).substring(2, 8);
            return `LAND${timestamp}${randomStr}`.toUpperCase();
        }

        // Calculate center point of polygon
        function calculateCenter(coordinates) {
            let latSum = 0;
            let lngSum = 0;
            
            coordinates.forEach(coord => {
                latSum += coord[0];
                lngSum += coord[1];
            });
            
            return [
                latSum / coordinates.length,
                lngSum / coordinates.length
            ];
        }

        // Text-to-speech function
        function speakText(text) {
            if (!speechEnabled || !window.speechSynthesis) return;
            
            // Cancel any ongoing speech
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'hi-IN';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            window.speechSynthesis.speak(utterance);
        }

        // Add speech to buttons
        function setupButtonSpeech(button, hindiText) {
            if (!speechEnabled) return;
            
            button.addEventListener('click', function() {
                if (!button.disabled) {
                    speakText(hindiText);
                    
                    // Add speaking class for visual feedback
                    button.classList.add('speaking');
                    setTimeout(() => {
                        button.classList.remove('speaking');
                    }, 2000);
                }
            });
        }

        // Update UI language
        function updateUILanguage(language) {
            currentLanguage = language;
            speechEnabled = language === 'Hindi';
            
            if (language === 'Hindi') {
                // Update all text content to Hindi
                document.getElementById('mappingTitle').textContent = 'जमीन मैपिंग';
                document.getElementById('overviewTitle').textContent = 'जमीनों का अवलोकन';
                document.getElementById('startTrackingText').textContent = 'ट्रैकिंग शुरू करें';
                document.getElementById('stopTrackingText').textContent = 'ट्रैकिंग रोकें';
                document.getElementById('addCornerText').textContent = 'कोना जोड़ें';
                document.getElementById('finishLandText').textContent = 'जमीन पूरी करें';
                document.getElementById('resetAllText').textContent = 'सब रीसेट करें';
                document.getElementById('statusLabel').textContent = 'स्थिति:';
                document.getElementById('locationLabel').textContent = 'वर्तमान स्थान:';
                document.getElementById('accuracyLabel').textContent = 'सटीकता:';
                document.getElementById('cornersTitle').textContent = 'वर्तमान जमीन के कोने';
                document.getElementById('noCornersText').textContent = 'अभी तक कोई कोना नहीं जोड़ा गया';
                document.getElementById('landInfoTitle').textContent = 'जमीन की जानकारी';
                document.getElementById('landNameLabel').textContent = 'जमीन का नाम *';
                document.getElementById('soilTypeLabel').textContent = 'मिट्टी का प्रकार *';
                document.getElementById('waterLabel').textContent = 'पानी की उपलब्धता *';
                document.getElementById('cropsLabel').textContent = 'वर्तमान फसलें';
                document.getElementById('landUseLabel').textContent = 'जमीन का उपयोग';
                document.getElementById('saveLandText').textContent = 'जमीन सहेजें';
                document.getElementById('cancelLandText').textContent = 'रद्द करें';
                document.getElementById('yourLandsTitle').textContent = 'आपकी कृषि भूमि';
                document.getElementById('overviewMapTitle').textContent = 'सभी जमीनों का अवलोकन';
                document.getElementById('noLandsText').textContent = 'अभी तक कोई जमीन मैप नहीं की गई है। ट्रैकिंग शुरू करें और अपनी पहली जमीन बनाने के लिए कोने जोड़ें।';
                document.getElementById('totalAreaTitle').textContent = 'कुल खेत का क्षेत्रफल';
                document.getElementById('landMapTitle').textContent = 'जमीन का मानचित्र दृश्य';
                document.getElementById('landInfoDetailsTitle').textContent = 'जमीन की जानकारी';
                document.getElementById('coordinatesTitle').textContent = 'जमीन के निर्देशांक';
                document.getElementById('cornerHeader').textContent = 'कोना';
                document.getElementById('latitudeHeader').textContent = 'अक्षांश';
                document.getElementById('longitudeHeader').textContent = 'देशांतर';
                document.getElementById('distanceHeader').textContent = 'शुरुआत से दूरी';
                // Update placeholders
                landNameInput.placeholder = 'जमीन का नाम दर्ज करें';
                currentCropsInput.placeholder = 'वर्तमान फसलें दर्ज करें';
                
                // Update select options
                updateSelectOptionsHindi();
                
                // Update status messages
                if (statusElement.textContent === 'Ready to start') {
                    statusElement.textContent = 'शुरू करने के लिए तैयार';
                }
                
                // Setup button speech for Hindi
                setupButtonSpeech(startTrackingBtn, 'ट्रैकिंग शुरू करें');
                setupButtonSpeech(stopTrackingBtn, 'ट्रैकिंग रोकें');
                setupButtonSpeech(addCornerBtn, 'कोना जोड़ें');
                setupButtonSpeech(finishLandBtn, 'जमीन पूरी करें');
                setupButtonSpeech(resetAllBtn, 'सब रीसेट करें');
                setupButtonSpeech(backToProfileBtn, 'प्रोफाइल पर वापस जाएं');
                setupButtonSpeech(logoutBtn, 'लॉग आउट');
                setupButtonSpeech(saveLandBtn, 'जमीन सहेजें');
                setupButtonSpeech(cancelLandBtn, 'रद्द करें');
                
            } else {
                // Reset to English (default)
                document.getElementById('mappingTitle').textContent = 'Land Mapping';
                document.getElementById('overviewTitle').textContent = 'Lands Overview';
                document.getElementById('startTrackingText').textContent = 'Start Tracking';
                document.getElementById('stopTrackingText').textContent = 'Stop Tracking';
                document.getElementById('addCornerText').textContent = 'Add Corner';
                document.getElementById('finishLandText').textContent = 'Finish Land';
                document.getElementById('resetAllText').textContent = 'Reset All';
                document.getElementById('statusLabel').textContent = 'Status:';
                document.getElementById('locationLabel').textContent = 'Current Location:';
                document.getElementById('accuracyLabel').textContent = 'Accuracy:';
                document.getElementById('cornersTitle').textContent = 'Current Land Corners';
                document.getElementById('noCornersText').textContent = 'No corners added yet';
                document.getElementById('landInfoTitle').textContent = 'Land Information';
                document.getElementById('landNameLabel').textContent = 'Land Name *';
                document.getElementById('soilTypeLabel').textContent = 'Soil Type *';
                document.getElementById('waterLabel').textContent = 'Water Availability *';
                document.getElementById('cropsLabel').textContent = 'Current Crops';
                document.getElementById('landUseLabel').textContent = 'Land Use';
                document.getElementById('saveLandText').textContent = 'Save Land';
                document.getElementById('cancelLandText').textContent = 'Cancel';
                document.getElementById('yourLandsTitle').textContent = 'Your Farm Lands';
                document.getElementById('overviewMapTitle').textContent = 'All Lands Overview';
                document.getElementById('noLandsText').textContent = 'No lands mapped yet. Start tracking and add corners to create your first land.';
                document.getElementById('totalAreaTitle').textContent = 'Total Farm Area';
                document.getElementById('landMapTitle').textContent = 'Land Map View';
                document.getElementById('landInfoDetailsTitle').textContent = 'Land Information';
                document.getElementById('coordinatesTitle').textContent = 'Land Coordinates';
                document.getElementById('cornerHeader').textContent = 'Corner';
                document.getElementById('latitudeHeader').textContent = 'Latitude';
                document.getElementById('longitudeHeader').textContent = 'Longitude';
                document.getElementById('distanceHeader').textContent = 'Distance from Start';
                
                // Reset placeholders
                landNameInput.placeholder = 'Enter land name';
                currentCropsInput.placeholder = 'Enter current crops';
                
                // Reset select options
                updateSelectOptionsEnglish();
                
                // Reset status messages
                if (statusElement.textContent === 'शुरू करने के लिए तैयार') {
                    statusElement.textContent = 'Ready to start';
                }
            }
        }

        function updateSelectOptionsHindi() {
            // Soil Type options
            soilTypeInput.innerHTML = `
                <option value="">मिट्टी का प्रकार चुनें</option>
                <option value="sandy">बलुई मिट्टी</option>
                <option value="clay">चिकनी मिट्टी</option>
                <option value="loamy">दोमट मिट्टी</option>
                <option value="silt">गाद मिट्टी</option>
                <option value="peaty">पीट मिट्टी</option>
                <option value="chalky">चूना मिट्टी</option>
            `;
            
            // Water Availability options
            waterAvailabilityInput.innerHTML = `
                <option value="">पानी की उपलब्धता चुनें</option>
                <option value="excellent">उत्कृष्ट</option>
                <option value="good">अच्छा</option>
                <option value="moderate">मध्यम</option>
                <option value="poor">कम</option>
                <option value="seasonal">मौसमी</option>
            `;
            
            // Land Use options
            landUseInput.innerHTML = `
                <option value="">जमीन का उपयोग चुनें</option>
                <option value="agriculture">कृषि</option>
                <option value="orchard">बागवानी</option>
                <option value="pasture">चरागाह</option>
                <option value="mixed">मिश्रित उपयोग</option>
                <option value="fallow">परती भूमि</option>
            `;
        }

        function updateSelectOptionsEnglish() {
            // Soil Type options
            soilTypeInput.innerHTML = `
                <option value="">Select Soil Type</option>
                <option value="sandy">Sandy Soil</option>
                <option value="clay">Clay Soil</option>
                <option value="loamy">Loamy Soil</option>
                <option value="silt">Silt Soil</option>
                <option value="peaty">Peaty Soil</option>
                <option value="chalky">Chalky Soil</option>
            `;
            
            // Water Availability options
            waterAvailabilityInput.innerHTML = `
                <option value="">Select Water Availability</option>
                <option value="excellent">Excellent</option>
                <option value="good">Good</option>
                <option value="moderate">Moderate</option>
                <option value="poor">Poor</option>
                <option value="seasonal">Seasonal</option>
            `;
            
            // Land Use options
            landUseInput.innerHTML = `
                <option value="">Select Land Use</option>
                <option value="agriculture">Agriculture</option>
                <option value="orchard">Orchard</option>
                <option value="pasture">Pasture</option>
                <option value="mixed">Mixed Use</option>
                <option value="fallow">Fallow Land</option>
            `;
        }

        // Get user language from database
        async function getUserLanguage() {
            try {
                const profile = await userProfile.getUserProfile();
                if (!profile) return 'English';
                return profile.language || 'English';
            } catch (error) {
                console.error('Error in getUserLanguage:', error);
                return 'English';
            }
        }

        // Event Listeners
        function setupEventListeners() {
            startTrackingBtn.addEventListener('click', startTracking);
            stopTrackingBtn.addEventListener('click', stopTracking);
            addCornerBtn.addEventListener('click', addCorner);
            finishLandBtn.addEventListener('click', showLandForm);
            resetAllBtn.addEventListener('click', resetAll);
            backToProfileBtn.addEventListener('click', goToProfile);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Form event listeners
            saveLandBtn.addEventListener('click', saveLand);
            cancelLandBtn.addEventListener('click', cancelLandForm);
            
            // Modal event listeners
            closeModalBtn.addEventListener('click', closeLandDetailsModal);
            
            // Close modal when clicking outside
            landDetailsModal.addEventListener('click', function(e) {
                if (e.target === landDetailsModal) {
                    closeLandDetailsModal();
                }
            });
        }

        function goToProfile() {
            window.location.href = 'profile.html';
        }

        async function handleLogout() {
            const success = await authChecker.signOut();
            if (success) {
                window.location.href = 'login.html';
            }
        }

        async function loadUserLands() {
            try {
                const profile = await userProfile.getUserProfile();
                if (!profile) {
                    console.error('User profile not found');
                    return;
                }

                // Get lands data using auth_id
                const { data: lands, error: landsError } = await window.supabaseClient
                    .from('lands')
                    .select('*')
                    .eq('auth_id', profile.auth_id)
                    .order('created_at', { ascending: false });

                if (landsError) {
                    console.error('Error loading lands:', landsError);
                    return;
                }

                // Get coordinates for each land
                for (let land of lands) {
                    const { data: coordinates, error: coordsError } = await window.supabaseClient
                        .from('land_coordinates')
                        .select('*')
                        .eq('land_id', land.land_id)
                        .order('corner_index', { ascending: true });

                    if (coordsError) {
                        console.error('Error loading coordinates:', coordsError);
                        continue;
                    }

                    // Reconstruct corners array
                    const corners = coordinates.map(coord => [coord.latitude, coord.longitude]);
                    
                    // Add to allLands array
                    allLands.push({
                        ...land,
                        corners: corners,
                        id: land.land_id
                    });

                    // Add polygon to maps
                    addLandToMaps(land, corners);
                }

                // Update UI
                updateLandsList();
                
                // Fit maps to show all lands
                if (allLands.length > 0) {
                    fitMapsToLands();
                }

            } catch (error) {
                console.error('Error in loadUserLands:', error);
            }
        }

        function addLandToMaps(land, corners) {
            // Add to main map
            const poly = L.polygon(corners, {
                color: '#2e7d32', 
                fillColor: '#4caf50',
                fillOpacity: 0.3,
                weight: 3
            }).addTo(map);
            
            drawnLayers.push(poly);

            // Add to overview map
            const overviewPoly = L.polygon(corners, {
                color: '#1976d2', 
                fillColor: '#2196f3',
                fillOpacity: 0.4,
                weight: 2
            }).addTo(landsOverviewMap);
            
            overviewLayers.push(overviewPoly);

            // Add popups
            poly.bindPopup(createLandPopup(land, '#2e7d32'));
            overviewPoly.bindPopup(createLandPopup(land, '#1976d2'));
        }

        function createLandPopup(land, color) {
            const viewDetailsText = currentLanguage === 'Hindi' ? 'विवरण देखें' : 'View Details';
            return `
                <div style="min-width: 200px;">
                    <h4 style="margin: 0 0 8px 0; color: ${color};">${land.land_name}</h4>
                    <p style="margin: 4px 0;"><strong>${currentLanguage === 'Hindi' ? 'क्षेत्रफल:' : 'Area:'}</strong> ${parseFloat(land.area_acres).toFixed(2)} ${currentLanguage === 'Hindi' ? 'एकड़' : 'acres'}</p>
                    <p style="margin: 4px 0;"><strong>${currentLanguage === 'Hindi' ? 'मिट्टी:' : 'Soil:'}</strong> ${getSoilTypeLabel(land.soil_type)}</p>
                    <p style="margin: 4px 0;"><strong>${currentLanguage === 'Hindi' ? 'पानी:' : 'Water:'}</strong> ${land.water_availability}</p>
                    <button onclick="openLandDetails(${allLands.findIndex(l => l.land_id === land.land_id)})" 
                            style="background: ${color}; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 5px;">
                        ${viewDetailsText}
                    </button>
                </div>
            `;
        }

        function fitMapsToLands() {
            if (drawnLayers.length > 0) {
                const group = new L.featureGroup(drawnLayers);
                map.fitBounds(group.getBounds());
            }
            
            if (overviewLayers.length > 0) {
                const overviewGroup = new L.featureGroup(overviewLayers);
                landsOverviewMap.fitBounds(overviewGroup.getBounds());
            }
        }

        function checkLocationPermission() {
            if (!navigator.permissions) return;
            
            navigator.permissions.query({ name: 'geolocation' }).then(function(result) {
                if (result.state === 'granted') {
                    console.log("Location permission already granted");
                }
            });
        }

        function showLocationError(message) {
            locationErrorText.textContent = message;
            locationErrorElement.style.display = 'block';
        }

        function hideLocationError() {
            locationErrorElement.style.display = 'none';
        }

        function updateButtonStates() {
            const isTracking = watchId !== null;
            const hasLocation = currentCoords !== null;
            const hasCorners = currentCorners.length > 0;

            startTrackingBtn.disabled = isTracking;
            stopTrackingBtn.disabled = !isTracking;
            addCornerBtn.disabled = !isTracking || !hasLocation;
            finishLandBtn.disabled = !hasCorners || currentCorners.length < 3;
        }

        function startTracking() {
            hideLocationError();
            
            const statusText = currentLanguage === 'Hindi' ? 'स्थान ट्रैकिंग शुरू की जा रही है...' : 'Starting location tracking...';
            statusElement.textContent = statusText;
            statusElement.style.color = "#ff9800";

            // Clear any existing watcher
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            watchId = navigator.geolocation.watchPosition(
                handlePositionSuccess,
                handlePositionError,
                options
            );
        }

        function handlePositionSuccess(position) {
            const { latitude, longitude, accuracy } = position.coords;
            currentCoords = [latitude, longitude];
            locationAccuracy = accuracy;

            coordsElement.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            accuracyElement.textContent = `±${accuracy.toFixed(1)} ${currentLanguage === 'Hindi' ? 'मीटर' : 'meters'}`;
            
            const statusText = currentLanguage === 'Hindi' ? 'ट्रैकिंग सक्रिय' : 'Tracking active';
            statusElement.textContent = statusText;
            statusElement.style.color = "#4caf50";

            // Update or create marker
            if (currentPosMarker) {
                currentPosMarker.setLatLng(currentCoords);
            } else {
                const popupText = currentLanguage === 'Hindi' ? 
                    `<div>
                        <strong>वर्तमान स्थिति</strong><br>
                        अक्षांश: ${latitude.toFixed(6)}<br>
                        देशांतर: ${longitude.toFixed(6)}<br>
                        सटीकता: ±${accuracy.toFixed(1)}मी
                    </div>` :
                    `<div>
                        <strong>Current Position</strong><br>
                        Lat: ${latitude.toFixed(6)}<br>
                        Lng: ${longitude.toFixed(6)}<br>
                        Accuracy: ±${accuracy.toFixed(1)}m
                    </div>`;
                
                currentPosMarker = L.marker(currentCoords)
                    .addTo(map)
                    .bindPopup(popupText)
                    .openPopup();
            }

            // Center map on current position
            map.setView(currentCoords, Math.max(16, map.getZoom()));

            // Update button states
            updateButtonStates();
        }

        function handlePositionError(error) {
            let errorMessage = currentLanguage === 'Hindi' ? "अज्ञात स्थान त्रुटि" : "Unknown location error";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = currentLanguage === 'Hindi' ? 
                        "स्थान एक्सेस अस्वीकृत। मैपिंग सुविधाओं का उपयोग करने के लिए कृपया अपनी ब्राउज़र सेटिंग्स में स्थान एक्सेस की अनुमति दें।" :
                        "Location access denied. Please allow location access in your browser settings to use mapping features.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = currentLanguage === 'Hindi' ? "स्थान जानकारी उपलब्ध नहीं है।" : "Location information unavailable.";
                    break;
                case error.TIMEOUT:
                    errorMessage = currentLanguage === 'Hindi' ? "स्थान अनुरोध समय समाप्त।" : "Location request timed out.";
                    break;
            }

            showLocationError(errorMessage);
            const statusText = currentLanguage === 'Hindi' ? "स्थान त्रुटि" : "Location error";
            statusElement.textContent = statusText;
            statusElement.style.color = "#f44336";
            
            stopTracking();
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            const statusText = currentLanguage === 'Hindi' ? "ट्रैकिंग रोक दी गई" : "Tracking stopped";
            statusElement.textContent = statusText;
            statusElement.style.color = "#666";
            updateButtonStates();
        }

        function addCorner() {
            if (!currentCoords) { 
                const errorText = currentLanguage === 'Hindi' ? "कोई स्थान डेटा उपलब्ध नहीं" : "No location data available";
                showLocationError(errorText);
                return; 
            }
            
            currentCorners.push([...currentCoords]);
            updateCornerList();
            
            // Add visual marker for the corner
            const cornerMarker = L.circleMarker(currentCoords, {
                radius: 8, 
                color: "red", 
                fillColor: "#ff4444", 
                fillOpacity: 0.8,
                weight: 2
            }).addTo(map);
            
            const popupText = currentLanguage === 'Hindi' ?
                `<div>
                    <strong>कोना ${currentCorners.length}</strong><br>
                    अक्षांश: ${currentCoords[0].toFixed(6)}<br>
                    देशांतर: ${currentCoords[1].toFixed(6)}
                </div>` :
                `<div>
                    <strong>Corner ${currentCorners.length}</strong><br>
                    Lat: ${currentCoords[0].toFixed(6)}<br>
                    Lng: ${currentCoords[1].toFixed(6)}
                </div>`;
            
            cornerMarker.bindPopup(popupText);
                
            // Show success feedback
            const successText = currentLanguage === 'Hindi' ? `कोना ${currentCorners.length} जोड़ा गया!` : `Corner ${currentCorners.length} added!`;
            statusElement.textContent = successText;
            statusElement.style.color = "#ff9800";
            
            setTimeout(() => {
                if (watchId) {
                    const statusText = currentLanguage === 'Hindi' ? "ट्रैकिंग सक्रिय" : "Tracking active";
                    statusElement.textContent = statusText;
                    statusElement.style.color = "#4caf50";
                }
            }, 1500);

            updateButtonStates();
        }

        function updateCornerList() {
            const list = document.getElementById("cornerList");
            list.innerHTML = "";
            
            if (currentCorners.length === 0) {
                const noCornersText = currentLanguage === 'Hindi' ? 'अभी तक कोई कोना नहीं जोड़ा गया' : 'No corners added yet';
                list.innerHTML = `<li style="text-align: center; color: #999; padding: 20px;">${noCornersText}</li>`;
                return;
            }
            
            currentCorners.forEach((c, i) => {
                const li = document.createElement("li");
                li.className = "coordinate-item";
                li.innerHTML = `
                    <span><strong>${currentLanguage === 'Hindi' ? 'कोना' : 'Corner'} ${i+1}:</strong> ${c[0].toFixed(6)}, ${c[1].toFixed(6)}</span>
                    <span style="color: #666; font-size: 0.9rem;">${getDistanceFromStart(i)}</span>
                `;
                list.appendChild(li);
            });
        }

        function getDistanceFromStart(cornerIndex) {
            if (cornerIndex === 0) return currentLanguage === 'Hindi' ? "शुरुआती बिंदु" : "Start point";
            
            const start = currentCorners[0];
            const current = currentCorners[cornerIndex];
            
            const R = 6371000;
            const dLat = (current[0] - start[0]) * Math.PI / 180;
            const dLon = (current[1] - start[1]) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(start[0] * Math.PI / 180) * Math.cos(current[0] * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            if (distance < 1000) {
                return currentLanguage === 'Hindi' ? 
                    `${distance.toFixed(0)}मी शुरुआत से` : 
                    `${distance.toFixed(0)}m from start`;
            } else {
                return currentLanguage === 'Hindi' ? 
                    `${(distance/1000).toFixed(2)}किमी शुरुआत से` : 
                    `${(distance/1000).toFixed(2)}km from start`;
            }
        }

        function showLandForm() {
            if (currentCorners.length < 3) {
                const alertText = currentLanguage === 'Hindi' ? 
                    "जमीन बहुभुज बनाने के लिए कम से कम 3 कोने चाहिए" : 
                    "At least 3 corners needed to create a land polygon";
                alert(alertText);
                return;
            }
            landForm.classList.add('active');
            
            // Auto-generate land name if empty
            if (!landNameInput.value) {
                const landName = currentLanguage === 'Hindi' ? 'जमीन' : 'Land';
                landNameInput.value = `${landName} ${allLands.length + 1}`;
            }
        }

        function cancelLandForm() {
            landForm.classList.remove('active');
            resetForm();
        }

        function resetForm() {
            landNameInput.value = '';
            soilTypeInput.value = '';
            waterAvailabilityInput.value = '';
            currentCropsInput.value = '';
            landUseInput.value = '';
        }

        async function saveLand() {
            // Validate required fields
            if (!landNameInput.value.trim()) {
                const alertText = currentLanguage === 'Hindi' ? "कृपया जमीन का नाम दर्ज करें" : "Please enter a land name";
                alert(alertText);
                landNameInput.focus();
                return;
            }
            
            if (!soilTypeInput.value) {
                const alertText = currentLanguage === 'Hindi' ? "कृपया मिट्टी का प्रकार चुनें" : "Please select soil type";
                alert(alertText);
                soilTypeInput.focus();
                return;
            }
            
            if (!waterAvailabilityInput.value) {
                const alertText = currentLanguage === 'Hindi' ? "कृपया पानी की उपलब्धता चुनें" : "Please select water availability";
                alert(alertText);
                waterAvailabilityInput.focus();
                return;
            }

            // Show loading state
            saveLandBtn.disabled = true;
            const saveText = currentLanguage === 'Hindi' ? 'जमीन सहेजी जा रही है...' : 'Saving Land...';
            saveLandBtn.innerHTML = `<div class="loader-small"></div>${saveText}`;

            try {
                // Get current user info and profile
                const user = await authChecker.getCurrentUser();
                const profile = await userProfile.getOrCreateUserProfile();
                
                if (!user || !profile) {
                    throw new Error('User not authenticated or profile not found');
                }

                // Calculate area and perimeter
                const polygonCoords = currentCorners.map(c => [c[1], c[0]]);
                polygonCoords.push([currentCorners[0][1], currentCorners[0][0]]); // Close the polygon
                const polygon = turf.polygon([polygonCoords]);
                let areaSqMeters = turf.area(polygon);
                let areaHectares = areaSqMeters / 10000;
                let areaAcres = areaSqMeters / 4046.856;
                let perimeter = calculatePerimeter();
                let center = calculateCenter(currentCorners);

                // Generate unique land ID
                const landId = generateLandId();

                // Save land to database
                const { data: landData, error: landError } = await window.supabaseClient
                    .from('lands')
                    .insert([{
                        land_id: landId,
                        auth_id: user.id,
                        user_id: profile.user_id, // Use the user_id from profile
                        land_name: landNameInput.value.trim(),
                        soil_type: soilTypeInput.value,
                        water_availability: waterAvailabilityInput.value,
                        current_crops: currentCropsInput.value.trim() || null,
                        land_use: landUseInput.value || null,
                        area_sq_meters: areaSqMeters,
                        area_hectares: areaHectares,
                        area_acres: areaAcres,
                        perimeter_meters: perimeter,
                        center_lat: center[0],
                        center_lng: center[1]
                    }]);

                if (landError) {
                    throw new Error(`Failed to save land: ${landError.message}`);
                }

                // Save coordinates to database
                const coordinatesData = currentCorners.map((corner, index) => ({
                    land_id: landId,
                    auth_id: user.id,
                    corner_index: index,
                    latitude: corner[0],
                    longitude: corner[1]
                }));

                const { error: coordsError } = await window.supabaseClient
                    .from('land_coordinates')
                    .insert(coordinatesData);

                if (coordsError) {
                    throw new Error(`Failed to save coordinates: ${coordsError.message}`);
                }

                // Create land object for local storage
                const newLand = { 
                    land_id: landId,
                    auth_id: user.id,
                    user_id: profile.user_id,
                    land_name: landNameInput.value.trim(),
                    soil_type: soilTypeInput.value,
                    water_availability: waterAvailabilityInput.value,
                    current_crops: currentCropsInput.value.trim(),
                    land_use: landUseInput.value,
                    area_sq_meters: areaSqMeters,
                    area_hectares: areaHectares,
                    area_acres: areaAcres,
                    perimeter_meters: perimeter,
                    center_lat: center[0],
                    center_lng: center[1],
                    corners: [...currentCorners],
                    created_at: new Date().toISOString()
                };
                
                // Add to lands array
                allLands.push(newLand);
                
                // Add polygon to maps
                addLandToMaps(newLand, currentCorners);

                // Update UI
                updateLandsList();
                landForm.classList.remove('active');
                resetForm();

                // Reset current land
                currentCorners = [];
                updateCornerList();
                updateButtonStates();

                // Fit both maps to show all lands
                fitMapsToLands();

                // Show success message and redirect to profile
                const successMessage = currentLanguage === 'Hindi' ?
                    `✅ ${newLand.land_name} सफलतापूर्वक बनाई गई!\nक्षेत्रफल: ${newLand.area_acres.toFixed(2)} एकड़\nप्रोफाइल पर रीडायरेक्ट किया जा रहा है...` :
                    `✅ ${newLand.land_name} created successfully!\nArea: ${newLand.area_acres.toFixed(2)} acres\nRedirecting to profile...`;
                
                alert(successMessage);
                
                // Redirect to profile after 2 seconds
            

            } catch (error) {
                console.error('Error saving land:', error);
                const errorMessage = currentLanguage === 'Hindi' ? 'जमीन सहेजने में त्रुटि: ' : 'Error saving land: ';
                alert(errorMessage + error.message);
            } finally {
                // Reset button state
                const saveText = currentLanguage === 'Hindi' ? 'जमीन सहेजें' : 'Save Land';
                saveLandBtn.disabled = false;
                saveLandBtn.innerHTML = `<i class="fas fa-save"></i> ${saveText}`;
            }
        }

        function getSoilTypeLabel(soilType) {
            const soilTypes = {
                'sandy': currentLanguage === 'Hindi' ? 'बलुई मिट्टी' : 'Sandy Soil',
                'clay': currentLanguage === 'Hindi' ? 'चिकनी मिट्टी' : 'Clay Soil',
                'loamy': currentLanguage === 'Hindi' ? 'दोमट मिट्टी' : 'Loamy Soil',
                'silt': currentLanguage === 'Hindi' ? 'गाद मिट्टी' : 'Silt Soil',
                'peaty': currentLanguage === 'Hindi' ? 'पीट मिट्टी' : 'Peaty Soil',
                'chalky': currentLanguage === 'Hindi' ? 'चूना मिट्टी' : 'Chalky Soil'
            };
            return soilTypes[soilType] || soilType;
        }

        function calculatePerimeter() {
            let perimeter = 0;
            for (let i = 0; i < currentCorners.length; i++) {
                const start = currentCorners[i];
                const end = currentCorners[(i + 1) % currentCorners.length];
                
                const R = 6371000;
                const dLat = (end[0] - start[0]) * Math.PI / 180;
                const dLon = (end[1] - start[1]) * Math.PI / 180;
                const a = 
                    Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(start[0] * Math.PI / 180) * Math.cos(end[0] * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                perimeter += R * c;
            }
            return perimeter;
        }

        function updateLandsList() {
            const list = document.getElementById("landsList");
            const landCount = document.getElementById("landCount");
            const totalArea = document.getElementById("totalArea");
            
            list.innerHTML = "";
            let totalMeters = 0;
            let totalAcres = 0;
            let totalHectares = 0;

            if (allLands.length === 0) {
                const noLandsText = currentLanguage === 'Hindi' ? 
                    'अभी तक कोई जमीन मैप नहीं की गई है। ट्रैकिंग शुरू करें और अपनी पहली जमीन बनाने के लिए कोने जोड़ें।' :
                    'No lands mapped yet. Start tracking and add corners to create your first land.';
                
                list.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 40px;">
                        <i class="fas fa-tractor" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>${noLandsText}</p>
                    </div>
                `;
                const landCountText = currentLanguage === 'Hindi' ? '0 जमीनें' : '0 lands';
                landCount.textContent = landCountText;
                totalArea.textContent = "—";
                return;
            }

            allLands.forEach((land, i) => {
                totalMeters += parseFloat(land.area_sq_meters);
                totalAcres += parseFloat(land.area_acres);
                totalHectares += parseFloat(land.area_hectares);

                const div = document.createElement("div");
                div.className = "land-item";
                div.setAttribute('data-land-index', i);
                div.innerHTML = `
                    <div class="land-header">
                        <span class="land-title">${land.land_name}</span>
                        <span class="land-details">${parseFloat(land.area_acres).toFixed(2)} ${currentLanguage === 'Hindi' ? 'एकड़' : 'acres'}</span>
                    </div>
                    <div class="land-details">
                        ${getSoilTypeLabel(land.soil_type)} • ${land.water_availability}
                    </div>
                    <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">
                        ${land.corners.length} ${currentLanguage === 'Hindi' ? 'कोने' : 'corners'} • ${parseFloat(land.area_sq_meters).toFixed(0)} m²
                        ${land.current_crops ? ' • ' + land.current_crops : ''}
                    </div>
                `;
                
                div.addEventListener('click', function() {
                    openLandDetails(i);
                });
                
                list.appendChild(div);
            });

            const landCountText = currentLanguage === 'Hindi' ? 
                `${allLands.length} जमीन${allLands.length > 1 ? 'ें' : ''}` : 
                `${allLands.length} land${allLands.length > 1 ? 's' : ''}`;
            landCount.textContent = landCountText;
            
            totalArea.innerHTML = `
                ${totalMeters.toFixed(2)} m²<br>
                ${totalHectares.toFixed(4)} ha<br>
                ${totalAcres.toFixed(4)} ${currentLanguage === 'Hindi' ? 'एकड़' : 'acres'}
            `;
        }

        function openLandDetails(landIndex) {
            selectedLandIndex = landIndex;
            const land = allLands[landIndex];
            
            // Update modal title
            modalLandTitle.textContent = land.land_name;
            
            // Update land information
            const soilText = currentLanguage === 'Hindi' ? 'मिट्टी का प्रकार:' : 'Soil Type:';
            const waterText = currentLanguage === 'Hindi' ? 'पानी की उपलब्धता:' : 'Water Availability:';
            const cropsText = currentLanguage === 'Hindi' ? 'वर्तमान फसलें:' : 'Current Crops:';
            const landUseText = currentLanguage === 'Hindi' ? 'जमीन का उपयोग:' : 'Land Use:';
            const areaText = currentLanguage === 'Hindi' ? 'क्षेत्रफल:' : 'Area:';
            const perimeterText = currentLanguage === 'Hindi' ? 'परिधि:' : 'Perimeter:';
            const cornersText = currentLanguage === 'Hindi' ? 'कोनों की संख्या:' : 'Number of Corners:';
            const notSpecified = currentLanguage === 'Hindi' ? 'निर्दिष्ट नहीं' : 'Not specified';
            
            landInfoDetails.innerHTML = `
                <div style="margin-bottom: 10px;"><strong>${soilText}</strong> ${getSoilTypeLabel(land.soil_type)}</div>
                <div style="margin-bottom: 10px;"><strong>${waterText}</strong> ${land.water_availability}</div>
                <div style="margin-bottom: 10px;"><strong>${cropsText}</strong> ${land.current_crops || notSpecified}</div>
                <div style="margin-bottom: 10px;"><strong>${landUseText}</strong> ${land.land_use || notSpecified}</div>
                <div style="margin-bottom: 10px;"><strong>${areaText}</strong> ${parseFloat(land.area_acres).toFixed(2)} ${currentLanguage === 'Hindi' ? 'एकड़' : 'acres'} (${parseFloat(land.area_sq_meters).toFixed(0)} m²)</div>
                <div style="margin-bottom: 10px;"><strong>${perimeterText}</strong> ${parseFloat(land.perimeter_meters).toFixed(2)} ${currentLanguage === 'Hindi' ? 'मीटर' : 'meters'}</div>
                <div><strong>${cornersText}</strong> ${land.corners.length}</div>
            `;
            
            // Initialize land details map
            initializeLandDetailsMap(land);
            
            // Update coordinates table
            updateCoordinatesTable(land);
            
            // Show modal
            landDetailsModal.style.display = 'flex';
        }

        function initializeLandDetailsMap(land) {
            if (landDetailsMap) {
                landDetailsMap.remove();
            }
            
            landDetailsMap = L.map('landDetailsMap').setView(land.corners[0], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(landDetailsMap);
            
            const poly = L.polygon(land.corners, {
                color: '#2e7d32',
                fillColor: '#4caf50',
                fillOpacity: 0.3,
                weight: 3
            }).addTo(landDetailsMap);
            
            land.corners.forEach((corner, index) => {
                const popupText = currentLanguage === 'Hindi' ?
                    `<div>
                        <strong>कोना ${index + 1}</strong><br>
                        अक्षांश: ${corner[0].toFixed(6)}<br>
                        देशांतर: ${corner[1].toFixed(6)}
                    </div>` :
                    `<div>
                        <strong>Corner ${index + 1}</strong><br>
                        Lat: ${corner[0].toFixed(6)}<br>
                        Lng: ${corner[1].toFixed(6)}
                    </div>`;
                
                L.circleMarker(corner, {
                    radius: 6,
                    color: 'red',
                    fillColor: '#ff4444',
                    fillOpacity: 0.8,
                    weight: 2
                }).addTo(landDetailsMap)
                .bindPopup(popupText);
            });
            
            landDetailsMap.fitBounds(poly.getBounds());
        }

        function updateCoordinatesTable(land) {
            coordinatesTableBody.innerHTML = '';
            
            land.corners.forEach((corner, index) => {
                const row = document.createElement('tr');
                
                let distance = currentLanguage === 'Hindi' ? 'शुरुआत' : 'Start';
                if (index > 0) {
                    const start = land.corners[0];
                    const R = 6371000;
                    const dLat = (corner[0] - start[0]) * Math.PI / 180;
                    const dLon = (corner[1] - start[1]) * Math.PI / 180;
                    const a = 
                        Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(start[0] * Math.PI / 180) * Math.cos(corner[0] * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const dist = R * c;
                    if (dist < 1000) {
                        distance = currentLanguage === 'Hindi' ? `${dist.toFixed(0)}मी` : `${dist.toFixed(0)}m`;
                    } else {
                        distance = currentLanguage === 'Hindi' ? `${(dist/1000).toFixed(2)}किमी` : `${(dist/1000).toFixed(2)}km`;
                    }
                }
                
                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td>${corner[0].toFixed(6)}</td>
                    <td>${corner[1].toFixed(6)}</td>
                    <td>${distance}</td>
                `;
                coordinatesTableBody.appendChild(row);
            });
        }

        function closeLandDetailsModal() {
            landDetailsModal.style.display = 'none';
            selectedLandIndex = null;
            
            if (landDetailsMap) {
                landDetailsMap.remove();
                landDetailsMap = null;
            }
        }

        function resetAll() {
            const confirmText = currentLanguage === 'Hindi' ? 
                "क्या आप वाकई सभी वर्तमान कोने रीसेट करना चाहते हैं? यह सहेजी गई जमीनों को हटाएगा नहीं।" :
                "Are you sure you want to reset all current corners? This will not delete saved lands.";
            
            if (currentCorners.length > 0 && !confirm(confirmText)) {
                return;
            }
            
            stopTracking();
            currentCorners = [];
            updateCornerList();
            landForm.classList.remove('active');
            resetForm();
            
            // Clear current corners from map (but keep saved lands)
            drawnLayers.forEach(layer => {
                if (layer instanceof L.Polygon && !allLands.some(land => 
                    JSON.stringify(land.corners) === JSON.stringify(layer.getLatLngs()[0].map(ll => [ll.lat, ll.lng])))) {
                    map.removeLayer(layer);
                }
            });
            
            // Filter out temporary layers
            drawnLayers = drawnLayers.filter(layer => 
                allLands.some(land => 
                    JSON.stringify(land.corners) === JSON.stringify(layer.getLatLngs()[0].map(ll => [ll.lat, ll.lng]))
                )
            );
            
            if (currentPosMarker) {
                map.removeLayer(currentPosMarker);
                currentPosMarker = null;
            }
            
            const statusText = currentLanguage === 'Hindi' ? "शुरू करने के लिए तैयार" : "Ready to start";
            statusElement.textContent = statusText;
            statusElement.style.color = "#666";
            coordsElement.textContent = "—";
            accuracyElement.textContent = "—";
            currentCoords = null;
            
            updateButtonStates();
        }

        // Main initialization function
        async function initializeApp() {
            try {
                // Wait for Supabase to be available
                if (!window.supabaseClient) {
                    console.error('Supabase client not available');
                    return;
                }

                // Initialize maps first
                initializeMaps();
                
                // Check authentication
                const isAuthenticated = await authChecker.requireAuth();
                if (!isAuthenticated) return;

                // Get or create user profile
                currentUserProfile = await userProfile.getOrCreateUserProfile();
                if (!currentUserProfile) {
                    throw new Error('Failed to get or create user profile');
                }

                // Get user language and update UI
                const userLanguage = await getUserLanguage();
                updateUILanguage(userLanguage);

                // Get current user info
                const user = await authChecker.getCurrentUser();
                if (user && user.email) {
                    userAvatar.textContent = user.email.charAt(0).toUpperCase();
                }

                // Load user's lands from database
                await loadUserLands();

                // Setup event listeners
                setupEventListeners();

                // Check if geolocation is available
                if (!navigator.geolocation) {
                    showLocationError("Geolocation is not supported by your browser");
                    startTrackingBtn.disabled = true;
                    return;
                }

                // Check initial location permission
                checkLocationPermission();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('Error initializing application: ' + error.message);
            }
        }

        // Global function for popup buttons
        window.openLandDetails = openLandDetails;

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
