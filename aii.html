<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrowSmart - Crop Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        /* Your existing CSS styles remain the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        :root {
            --primary: #2E8B57;
            --primary-light: #3CB371;
            --primary-dark: #228B22;
            --secondary: #4682B4;
            --accent: #FFA500;
            --warning: #FF6347;
            --error: #DC143C;
            --background: #F5F5F5;
            --surface: #FFFFFF;
            --text: #2F4F4F;
            --text-light: #708090;
            --border: #E0E0E0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 24px rgba(0, 0, 0, 0.15);
            --radius: 16px;
            --gradient: linear-gradient(135deg, #2E8B57 0%, #3CB371 100%);
        }

        body {
            background-color: var(--background);
            color: var(--text);
            line-height: 1.6;
            padding: 16px;
            max-width: 100%;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-title i {
            font-size: 22px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .user-name {
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .location {
            font-size: 14px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Content Cards */
        .content-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--primary);
        }

        /* Current Crop Status */
        .current-crop-status {
            background: var(--gradient);
            color: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .crop-name {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .crop-stage {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        .progress-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .stage-duration {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Map Container */
        .map-container {
            margin-top: 15px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            height: 200px;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-nav {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }

        .map-nav-btn {
            background: var(--surface);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .map-nav-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Crop Information */
        .crop-info {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
        }

        .crop-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 15px;
        }

        .crop-detail-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .crop-detail-label {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .crop-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        /* Stage Conditions */
        .stage-conditions {
            margin-top: 20px;
        }

        .condition-item {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .condition-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .condition-met {
            background: var(--primary);
            color: white;
        }

        .condition-pending {
            background: var(--border);
            color: var(--text-light);
        }

        .condition-text {
            flex: 1;
            font-size: 14px;
        }

        /* Stage Navigation */
        .stage-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            gap: 10px;
        }

        .stage-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            justify-content: center;
        }

        .stage-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .stage-btn:disabled {
            background: var(--border);
            color: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Growth Stages Overview */
        .stages-overview {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            gap: 12px;
            margin-top: 15px;
        }

        .stage-indicator {
            min-width: 80px;
            text-align: center;
            padding: 12px 8px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stage-indicator.active {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .stage-indicator.completed {
            background: rgba(46, 139, 87, 0.1);
            border: 2px solid var(--primary);
        }

        .stage-emoji {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .stage-name-short {
            font-size: 12px;
            font-weight: 600;
        }

        /* Update Stage Button */
        .update-stage-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            margin-top: 15px;
        }

        .update-stage-btn:hover {
            background: #e69500;
            transform: translateY(-2px);
        }

        /* Crop Selection */
        .crop-selection {
            margin-top: 15px;
        }

        .crop-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            font-size: 16px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .crop-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }

        .crop-input::placeholder {
            color: var(--text-light);
        }

        .start-journey-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .start-journey-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .start-journey-btn:disabled {
            background: var(--border);
            color: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        /* Land Selection Styles - IMPROVED */
        .land-selection {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 15px;
        }

        .land-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .land-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .land-card.selected {
            border-color: var(--primary);
            background: rgba(46, 139, 87, 0.05);
        }

        .land-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .land-name {
            font-weight: 700;
            font-size: 16px;
            color: var(--text);
        }

        .land-area {
            font-size: 14px;
            color: var(--text-light);
            background: var(--background);
            padding: 4px 8px;
            border-radius: 8px;
        }

        .land-details {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
        }

        .land-detail {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-light);
        }

        .land-detail i {
            color: var(--primary);
            font-size: 12px;
        }

        .ai-advice {
            margin-top: 10px;
            padding: 10px;
            background: rgba(70, 130, 180, 0.08);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text);
            border-left: 3px solid var(--secondary);
        }

        .ai-advice-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            font-weight: 600;
            color: var(--secondary);
        }

        .ai-advice-header i {
            font-size: 14px;
        }

        .ai-advice-content {
            font-size: 13px;
            line-height: 1.4;
        }

        .land-selector {
            margin-bottom: 15px;
        }

        .land-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .land-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 139, 87, 0.1);
        }

        /* Next Steps Section */
        .next-steps {
            margin-top: 20px;
            padding: 15px;
            background: rgba(70, 130, 180, 0.1);
            border-radius: 10px;
            display: none;
        }

        .next-steps-title {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .next-steps-list {
            font-size: 14px;
            line-height: 1.5;
        }

        .next-steps-list li {
            margin-bottom: 8px;
        }

        /* Error Display */
        .error-display {
            background: rgba(220, 20, 60, 0.1);
            border: 1px solid var(--error);
            border-radius: var(--radius);
            padding: 15px;
            margin: 15px 0;
            display: none;
        }

        .error-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: var(--error);
            font-weight: 600;
        }

        .error-details {
            font-size: 14px;
            color: var(--text);
            line-height: 1.5;
        }

        .error-stack {
            background: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Bottom Navigation */
        .bottom-nav {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-around;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 32px);
            max-width: 480px;
            z-index: 1000;
            border: 1px solid var(--border);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            padding: 8px 12px;
            border-radius: 12px;
            text-decoration: none;
            color: inherit;
        }

        .nav-item.active {
            opacity: 1;
            color: var(--primary);
            background: rgba(46, 139, 87, 0.1);
        }

        .nav-item:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item span {
            font-size: 12px;
            font-weight: 600;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            body {
                padding: 16px;
                padding-bottom: 100px;
            }
            
            .header {
                margin-bottom: 16px;
                padding: 10px 0;
            }
            
            .crop-details {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .stage-navigation {
                flex-direction: column;
            }
            
            .bottom-nav {
                width: calc(100% - 32px);
                padding: 14px;
            }
            
            .nav-item span {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Error Display -->
        <div class="error-display" id="errorDisplay">
            <div class="error-header">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorTitle">Error Occurred</span>
            </div>
            <div class="error-details" id="errorDetails">
                An error occurred while processing your request.
            </div>
            <div class="error-stack" id="errorStack"></div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="app-title">
                <i class="fas fa-leaf"></i>
                GrowSmart
            </div>
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="location">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="locationText">Loading location...</span>
                </div>
            </div>
        </div>

        <!-- Current Crop Status -->
        <div class="current-crop-status">
            <div class="crop-name" id="currentCropName">No crop selected</div>
            <div class="crop-stage" id="currentStageDisplay">ðŸŒ± Select a crop to begin</div>
            <div class="progress-container">
                <div class="progress-bar" id="stageProgress" style="width: 0%"></div>
            </div>
            <div class="stage-duration" id="stageDurationDisplay">Start your crop journey</div>
        </div>

        <!-- Land and Crop Selection - IMPROVED -->
        <div class="content-card">
            <div class="section-title">
                <i class="fas fa-map-marked-alt"></i>
                Select Land & Crop
            </div>
            
            <!-- Land Selection Cards -->
            <div class="land-selection" id="landSelection">
                <!-- Land cards will be populated here -->
            </div>
            
            <div class="map-container">
                <div id="map"></div>
                <div class="map-nav">
                    <button class="map-nav-btn" id="prevLandBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="map-nav-btn" id="nextLandBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
            
            <div class="crop-selection">
                <div class="crop-detail-item" style="margin-top: 15px;">
                    <div class="crop-detail-label">Selected Land</div>
                    <div class="crop-detail-value" id="selectedLand">No land selected</div>
                </div>
                
                <div class="crop-detail-item">
                    <div class="crop-detail-label">Soil Type</div>
                    <div class="crop-detail-value" id="soilType">-</div>
                </div>
                
                <div class="crop-detail-item">
                    <div class="crop-detail-label">Water Availability</div>
                    <div class="crop-detail-value" id="waterAvailability">-</div>
                </div>
                
                <input type="text" class="crop-input" id="cropNameInput" placeholder="Enter crop name (e.g., Cotton, Wheat, Corn)">
                
                <button class="start-journey-btn" id="startJourneyBtn" disabled>
                    <i class="fas fa-play-circle"></i>
                    Start Crop Journey
                </button>
            </div>
        </div>

        <!-- Crop Information -->
        <div class="content-card" id="cropInfoCard" style="display: none;">
            <div class="section-title">
                <i class="fas fa-seedling"></i>
                Crop Information
            </div>
            
            <div class="crop-info">
                <div class="crop-details">
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Planting Date</div>
                        <div class="crop-detail-value" id="plantingDate">-</div>
                    </div>
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Expected Harvest</div>
                        <div class="crop-detail-value" id="expectedHarvest">-</div>
                    </div>
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Area</div>
                        <div class="crop-detail-value" id="cropArea">-</div>
                    </div>
                    <div class="crop-detail-item">
                        <div class="crop-detail-label">Days Since Planting</div>
                        <div class="crop-detail-value" id="daysSincePlanting">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Stage Conditions -->
        <div class="content-card" id="stageConditionsCard" style="display: none;">
            <div class="section-title">
                <i class="fas fa-tasks"></i>
                Stage Conditions
            </div>
            
            <div class="stage-conditions" id="stageConditions">
                <!-- Conditions will be populated here -->
            </div>
            
            <!-- Next Steps Section -->
            <div class="next-steps" id="nextSteps">
                <div class="next-steps-title">
                    <i class="fas fa-arrow-right"></i>
                    Next Steps for Stage Completion
                </div>
                <ul class="next-steps-list" id="nextStepsList">
                    <!-- Next steps will be populated here -->
                </ul>
            </div>

            <!-- Update Stage Button -->
            <button class="update-stage-btn" id="updateStageBtn">
                <i class="fas fa-camera"></i>
                Update Plant Stage with AI
            </button>
        </div>

        <!-- Growth Stages Overview -->
        <div class="content-card" id="stagesOverviewCard" style="display: none;">
            <div class="section-title">
                <i class="fas fa-chart-line"></i>
                Growth Journey
            </div>
            
            <div class="stages-overview" id="stagesOverview">
                <!-- Stage indicators will be populated here -->
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="dashboard.html" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Dashboard</span>
        </a>
        <a href="soil.html" class="nav-item">
            <i class="fas fa-vial"></i>
            <span>Soil</span>
        </a>
        <a href="crops.html" class="nav-item active">
            <i class="fas fa-seedling"></i>
            <span>Crops</span>
        </a>
        <a href="blockchain.html" class="nav-item">
            <i class="fas fa-link"></i>
            <span>Blockchain</span>
        </a>
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </div>

    <!-- Include external scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-checker.js"></script>

    <script>
        // Global variables
        let map;
        let currentUser = null;
        let userLands = [];
        let currentLandIndex = 0;
        let currentCrop = null;
        let currentStage = 'germination';
        let landCrops = {}; // Store crops by land ID
        let userLocation = null;

        // Plant growth stages configuration
        const plantStages = {
            germination: {
                name: "Germination (Seed Stage)",
                emoji: "ðŸŒ±",
                duration: "Few days to 2 weeks",
                description: "The seed absorbs water and swells. The embryo inside starts to grow. The root (radicle) comes out first, followed by the shoot.",
                conditions: [
                    "Adequate moisture",
                    "Suitable temperature (20-25Â°C)",
                    "Proper soil depth"
                ],
                recommendations: [
                    "Maintain consistent soil moisture but avoid overwatering",
                    "Keep soil temperature between 20-25Â°C for optimal germination",
                    "Ensure proper seed depth according to crop type"
                ],
                durationDays: 14
            },
            seedling: {
                name: "Seedling Stage",
                emoji: "ðŸŒ¿",
                duration: "1â€“4 weeks",
                description: "The young plant develops its first true leaves. Roots grow deeper to absorb nutrients and water. The plant is delicate and needs proper care.",
                conditions: [
                    "Adequate light (12-16 hours daily)",
                    "Regular watering",
                    "Nutrient availability",
                    "Protection from pests"
                ],
                recommendations: [
                    "Provide adequate light for strong growth",
                    "Apply balanced, diluted fertilizer",
                    "Monitor for pests and diseases",
                    "Maintain consistent soil moisture"
                ],
                durationDays: 28
            },
            vegetative: {
                name: "Vegetative Growth Stage",
                emoji: "ðŸŒ¾",
                duration: "Several weeks to months",
                description: "Rapid growth phase â€” plant produces more leaves, stems, and roots. Focus is on building a strong structure for future flowering and fruiting.",
                conditions: [
                    "Adequate space between plants",
                    "Balanced nutrition",
                    "Proper pruning",
                    "Weed control",
                    "Adequate water supply"
                ],
                recommendations: [
                    "Increase nitrogen-rich fertilizer for leaf growth",
                    "Ensure proper spacing for air circulation",
                    "Implement weed control measures",
                    "Monitor for nutrient deficiencies"
                ],
                durationDays: 56
            },
            flowering: {
                name: "Flowering or Reproductive Stage",
                emoji: "ðŸŒ¸",
                duration: "1â€“4 weeks typically",
                description: "The plant begins to produce flowers or reproductive parts. Pollination occurs (by wind, insects, or manually).",
                conditions: [
                    "Proper pollination",
                    "Adequate light",
                    "Proper temperature",
                    "Reduced nitrogen",
                    "Increased phosphorus"
                ],
                recommendations: [
                    "Reduce nitrogen and increase phosphorus for flowering",
                    "Ensure pollinators have access",
                    "Consider manual pollination if needed",
                    "Maintain optimal temperature range"
                ],
                durationDays: 28
            },
            fruiting: {
                name: "Fruiting or Grain Filling Stage",
                emoji: "ðŸŒ¾",
                duration: "Varies widely (from weeks to months)",
                description: "After successful pollination, fruits or grains start developing. Nutrients and energy are directed toward filling seeds or fruits.",
                conditions: [
                    "Adequate water supply",
                    "Nutrient availability",
                    "Pest control",
                    "Disease management",
                    "Proper support for heavy fruits"
                ],
                recommendations: [
                    "Apply potassium-rich fertilizer for fruit development",
                    "Maintain consistent watering",
                    "Implement pest control measures",
                    "Provide support for heavy fruiting plants"
                ],
                durationDays: 42
            },
            maturity: {
                name: "Maturity and Harvesting Stage",
                emoji: "ðŸŒ»",
                duration: "Varies by crop",
                description: "Fruits, grains, or pods reach full size and ripen. Moisture levels drop, and the plant may begin to dry or turn yellow. Crops are ready for harvest.",
                conditions: [
                    "Proper harvest timing",
                    "Dry weather for harvesting",
                    "Storage preparation",
                    "Quality assessment"
                ],
                recommendations: [
                    "Reduce watering as harvest approaches",
                    "Monitor for optimal harvest time",
                    "Prepare storage facilities",
                    "Check crop quality before harvest"
                ],
                durationDays: 14
            }
        };

        const stageOrder = ['germination', 'seedling', 'vegetative', 'flowering', 'fruiting', 'maturity'];

        // DOM Elements
        const errorDisplay = document.getElementById('errorDisplay');
        const errorTitle = document.getElementById('errorTitle');
        const errorDetails = document.getElementById('errorDetails');
        const errorStack = document.getElementById('errorStack');
        const userName = document.getElementById('userName');
        const locationText = document.getElementById('locationText');
        const currentCropName = document.getElementById('currentCropName');
        const currentStageDisplay = document.getElementById('currentStageDisplay');
        const stageProgress = document.getElementById('stageProgress');
        const stageDurationDisplay = document.getElementById('stageDurationDisplay');
        const landSelection = document.getElementById('landSelection');
        const selectedLand = document.getElementById('selectedLand');
        const soilType = document.getElementById('soilType');
        const waterAvailability = document.getElementById('waterAvailability');
        const cropNameInput = document.getElementById('cropNameInput');
        const startJourneyBtn = document.getElementById('startJourneyBtn');
        const prevLandBtn = document.getElementById('prevLandBtn');
        const nextLandBtn = document.getElementById('nextLandBtn');
        const cropInfoCard = document.getElementById('cropInfoCard');
        const plantingDate = document.getElementById('plantingDate');
        const expectedHarvest = document.getElementById('expectedHarvest');
        const cropArea = document.getElementById('cropArea');
        const daysSincePlanting = document.getElementById('daysSincePlanting');
        const stageConditionsCard = document.getElementById('stageConditionsCard');
        const stageConditions = document.getElementById('stageConditions');
        const nextSteps = document.getElementById('nextSteps');
        const nextStepsList = document.getElementById('nextStepsList');
        const stagesOverviewCard = document.getElementById('stagesOverviewCard');
        const stagesOverview = document.getElementById('stagesOverview');
        const updateStageBtn = document.getElementById('updateStageBtn');

        // Error Handling Functions
        function showError(title, message, error = null) {
            console.error(`Error: ${title}`, message, error);
            
            errorTitle.textContent = title;
            errorDetails.textContent = message;
            
            if (error) {
                errorStack.textContent = `Stack: ${error.stack || 'No stack trace available'}\n\nDetails: ${JSON.stringify(error, null, 2)}`;
                errorStack.style.display = 'block';
            } else {
                errorStack.style.display = 'none';
            }
            
            errorDisplay.style.display = 'block';
        }

        function hideError() {
            errorDisplay.style.display = 'none';
        }

        // Initialize map
        function initializeMap() {
            try {
                map = L.map('map').setView([22.7196, 75.8577], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                }).addTo(map);
            } catch (error) {
                showError('Map Initialization Failed', 'Failed to initialize the map. Please check your internet connection.', error);
            }
        }

        // Update map with land coordinates
        function updateMapWithLand(land) {
            try {
                map.eachLayer(layer => {
                    if (layer instanceof L.Polygon) {
                        map.removeLayer(layer);
                    }
                });

                if (land && land.coordinates && land.coordinates.length > 0) {
                    // Create polygon from coordinates
                    const polygon = L.polygon(land.coordinates, {
                        color: '#2E8B57',
                        fillColor: '#3CB371',
                        fillOpacity: 0.3,
                        weight: 3
                    }).addTo(map);
                    
                    // Fit map to the polygon bounds
                    map.fitBounds(polygon.getBounds());
                    
                    // Add marker at center
                    L.marker([land.center_lat, land.center_lng])
                        .addTo(map)
                        .bindPopup(`<b>${land.land_name}</b><br>${land.area_acres} acres`)
                        .openPopup();
                }
            } catch (error) {
                showError('Map Update Failed', 'Failed to update map with land coordinates.', error);
            }
        }

        // Get user location
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        try {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            userLocation = { lat, lng };
                            
                            // Get location name using reverse geocoding
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                            const data = await response.json();
                            
                            if (data && data.address) {
                                const city = data.address.city || data.address.town || data.address.village || data.address.county;
                                const state = data.address.state;
                                locationText.textContent = city && state ? `${city}, ${state}` : 'Location found';
                            } else {
                                locationText.textContent = 'Location found';
                            }
                        } catch (error) {
                            locationText.textContent = 'Location found';
                        }
                    },
                    (error) => {
                        locationText.textContent = 'Location access denied';
                    }
                );
            } else {
                locationText.textContent = 'Geolocation not supported';
            }
        }

        // Load user data from Supabase
        async function loadUserData() {
            try {
                // Check authentication first
                const isAuthenticated = await window.authChecker.requireAuth();
                if (!isAuthenticated) {
                    showError('Authentication Required', 'Please log in to access this feature.');
                    return;
                }

                // Get current user
                currentUser = await window.authChecker.getCurrentUser();
                if (!currentUser) {
                    showError('User Not Found', 'No authenticated user found. Please log in again.');
                    return;
                }

                // Load user profile
                const { data: userProfile, error: userError } = await window.supabaseClient
                    .from('users')
                    .select('*')
                    .eq('auth_id', currentUser.id)
                    .single();
                
                if (userError) {
                    showError('Profile Load Failed', 'Failed to load user profile from database.', userError);
                } else if (userProfile) {
                    userName.textContent = userProfile.full_name;
                }

                // Load user lands
                const { data: lands, error: landsError } = await window.supabaseClient
                    .from('lands')
                    .select('*')
                    .eq('auth_id', currentUser.id);
                
                if (landsError) {
                    showError('Lands Load Failed', 'Failed to load user lands from database.', landsError);
                } else if (lands && lands.length > 0) {
                    userLands = lands;
                    
                    // Load coordinates for each land
                    for (let land of userLands) {
                        try {
                            const { data: coordinates, error: coordsError } = await window.supabaseClient
                                .from('land_coordinates')
                                .select('latitude, longitude, corner_index')
                                .eq('land_id', land.land_id)
                                .order('corner_index');
                            
                            if (!coordsError && coordinates && coordinates.length > 0) {
                                land.coordinates = coordinates.map(coord => [coord.latitude, coord.longitude]);
                            }
                        } catch (error) {
                            console.error('Error loading coordinates:', error);
                        }
                    }
                    
                    // Populate land cards
                    populateLandCards();
                    
                    // Load crops for each land
                    for (let land of userLands) {
                        await loadLandCrops(land.land_id);
                    }
                    
                    updateLandDisplay();
                } else {
                    selectedLand.textContent = 'No lands found';
                    prevLandBtn.disabled = true;
                    nextLandBtn.disabled = true;
                    landSelection.innerHTML = '<div class="no-lands-message">No lands available. Please add a land first.</div>';
                }

            } catch (error) {
                showError('User Data Load Failed', 'Failed to load user data. Please refresh the page.', error);
            }
        }

        // Populate land cards
        function populateLandCards() {
            landSelection.innerHTML = '';
            
            userLands.forEach((land, index) => {
                const landCard = document.createElement('div');
                landCard.className = `land-card ${index === currentLandIndex ? 'selected' : ''}`;
                landCard.setAttribute('data-land-index', index);
                
                // Generate AI advice based on land properties
                const aiAdvice = generateAIAdvice(land);
                
                landCard.innerHTML = `
                    <div class="land-card-header">
                        <div class="land-name">${land.land_name}</div>
                        <div class="land-area">${land.area_acres} acres</div>
                    </div>
                    <div class="land-details">
                        <div class="land-detail">
                            <i class="fas fa-mountain"></i>
                            <span>${land.soil_type || 'Unknown soil'}</span>
                        </div>
                        <div class="land-detail">
                            <i class="fas fa-tint"></i>
                            <span>${land.water_availability || 'Unknown'}</span>
                        </div>
                    </div>
                    <div class="ai-advice">
                        <div class="ai-advice-header">
                            <i class="fas fa-robot"></i>
                            <span>AI Recommendation</span>
                        </div>
                        <div class="ai-advice-content">
                            ${aiAdvice}
                        </div>
                    </div>
                `;
                
                landCard.addEventListener('click', () => {
                    currentLandIndex = index;
                    updateLandDisplay();
                });
                
                landSelection.appendChild(landCard);
            });
        }

        // Generate AI advice based on land properties
        function generateAIAdvice(land) {
            let advice = '';
            
            // Soil-based recommendations
            if (land.soil_type) {
                const soilType = land.soil_type.toLowerCase();
                if (soilType.includes('clay')) {
                    advice += 'Clay soil retains water well. Consider crops like rice, wheat, or cabbage. ';
                } else if (soilType.includes('sandy')) {
                    advice += 'Sandy soil drains quickly. Ideal for root vegetables like carrots and potatoes. ';
                } else if (soilType.includes('loam')) {
                    advice += 'Loam soil is balanced. Suitable for most crops including vegetables and grains. ';
                }
            }
            
            // Water availability recommendations
            if (land.water_availability) {
                const water = land.water_availability.toLowerCase();
                if (water.includes('high') || water.includes('good')) {
                    advice += 'Good water availability supports water-intensive crops like rice or sugarcane. ';
                } else if (water.includes('low') || water.includes('limited')) {
                    advice += 'Limited water availability. Consider drought-resistant crops like millet or sorghum. ';
                }
            }
            
            // Size-based recommendations
            if (land.area_acres) {
                const area = parseFloat(land.area_acres);
                if (area < 0.1) {
                    advice += 'Small plot suitable for high-value vegetables or herbs. ';
                } else if (area < 1) {
                    advice += 'Medium-sized land. Consider mixed cropping or specialty crops. ';
                } else {
                    advice += 'Large area suitable for staple crops or commercial farming. ';
                }
            }
            
            // Default advice if none generated
            if (!advice) {
                advice = 'Based on your location, consider seasonal crops appropriate for your region. ';
            }
            
            return advice;
        }

        // Load crops for a specific land
        async function loadLandCrops(landId) {
            try {
                const { data: crops, error } = await window.supabaseClient
                    .from('crops')
                    .select('*')
                    .eq('auth_id', currentUser.id)
                    .eq('land_id', landId);
                
                if (!error && crops && crops.length > 0) {
                    landCrops[landId] = crops;
                    
                    // Load stages for each crop
                    for (let crop of crops) {
                        await loadCropStages(crop.crop_id);
                    }
                    
                    // If there's an active crop on this land, set it as current
                    const activeCrop = crops.find(crop => crop.is_active);
                    if (activeCrop && userLands[currentLandIndex].land_id === landId) {
                        currentCrop = activeCrop;
                        updateCropDisplay();
                        showCropSections();
                    }
                } else {
                    landCrops[landId] = [];
                }
            } catch (error) {
                console.error('Error loading land crops:', error);
                landCrops[landId] = [];
            }
        }

        // Load crop stages from database
        async function loadCropStages(cropId) {
            try {
                const { data: stages, error } = await window.supabaseClient
                    .from('crop_stages')
                    .select('*')
                    .eq('crop_id', cropId)
                    .order('stage_order');
                
                if (!error && stages && stages.length > 0) {
                    // Find the crop in landCrops and update its stages
                    for (let landId in landCrops) {
                        const cropIndex = landCrops[landId].findIndex(crop => crop.crop_id === cropId);
                        if (cropIndex !== -1) {
                            if (!landCrops[landId][cropIndex].stages) {
                                landCrops[landId][cropIndex].stages = {};
                            }
                            
                            stages.forEach(stage => {
                                landCrops[landId][cropIndex].stages[stage.stage_key] = stage;
                            });
                            
                            // Update current stage
                            const activeStage = stages.find(stage => stage.is_current);
                            if (activeStage) {
                                landCrops[landId][cropIndex].current_stage = activeStage.stage_key;
                            }
                            
                            // If this is the current crop, update currentStage
                            if (currentCrop && currentCrop.crop_id === cropId) {
                                currentStage = landCrops[landId][cropIndex].current_stage;
                            }
                            
                            break;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading crop stages:', error);
            }
        }

        // Update land display
        function updateLandDisplay() {
            if (userLands.length === 0) {
                selectedLand.textContent = 'No lands found';
                soilType.textContent = '-';
                waterAvailability.textContent = '-';
                prevLandBtn.disabled = true;
                nextLandBtn.disabled = true;
                return;
            }
            
            const currentLand = userLands[currentLandIndex];
            selectedLand.textContent = currentLand.land_name;
            soilType.textContent = currentLand.soil_type || 'Not specified';
            waterAvailability.textContent = currentLand.water_availability || 'Not specified';
            
            // Update map
            updateMapWithLand(currentLand);
            
            // Update navigation buttons
            prevLandBtn.disabled = currentLandIndex === 0;
            nextLandBtn.disabled = currentLandIndex === userLands.length - 1;
            
            // Update land cards selection state
            document.querySelectorAll('.land-card').forEach((card, index) => {
                if (index === currentLandIndex) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
            
            // Check if this land has crops and update display
            const landId = currentLand.land_id;
            if (landCrops[landId] && landCrops[landId].length > 0) {
                // Find active crop for this land
                const activeCrop = landCrops[landId].find(crop => crop.is_active);
                if (activeCrop) {
                    currentCrop = activeCrop;
                    currentStage = activeCrop.current_stage;
                    updateCropDisplay();
                    showCropSections();
                } else {
                    // No active crop on this land
                    currentCrop = null;
                    hideCropSections();
                    updateCropDisplay();
                }
            } else {
                // No crops on this land
                currentCrop = null;
                hideCropSections();
                updateCropDisplay();
            }
        }

        // Show crop sections when a crop is active
        function showCropSections() {
            cropInfoCard.style.display = 'block';
            stageConditionsCard.style.display = 'block';
            stagesOverviewCard.style.display = 'block';
        }

        // Hide crop sections when no crop is active
        function hideCropSections() {
            cropInfoCard.style.display = 'none';
            stageConditionsCard.style.display = 'none';
            stagesOverviewCard.style.display = 'none';
        }

        // Update crop display
        function updateCropDisplay() {
            if (!currentCrop) {
                currentCropName.textContent = 'No crop selected';
                currentStageDisplay.textContent = 'ðŸŒ± Select a crop to begin';
                stageProgress.style.width = '0%';
                stageDurationDisplay.textContent = 'Start your crop journey';
                hideCropSections();
                return;
            }

            currentCropName.textContent = currentCrop.crop_name;
            
            if (currentCrop.planting_date) {
                plantingDate.textContent = new Date(currentCrop.planting_date).toLocaleDateString();
            } else {
                plantingDate.textContent = 'Not set';
            }
            
            if (currentCrop.expected_harvest_date) {
                expectedHarvest.textContent = new Date(currentCrop.expected_harvest_date).toLocaleDateString();
            } else {
                expectedHarvest.textContent = 'Not set';
            }
            
            cropArea.textContent = currentCrop.area_allocated ? 
                `${currentCrop.area_allocated} acres` : 'Not specified';
            
            // Calculate days since planting
            if (currentCrop.planting_date) {
                const planting = new Date(currentCrop.planting_date);
                const today = new Date();
                const days = Math.floor((today - planting) / (1000 * 60 * 60 * 24));
                daysSincePlanting.textContent = `${days} days`;
            } else {
                daysSincePlanting.textContent = 'Not set';
            }

            // Update current stage
            updateStageDisplay();
            showCropSections();
        }

        function updateStageDisplay() {
            const stage = plantStages[currentStage];
            if (!stage) {
                currentStageDisplay.textContent = 'ðŸŒ± Stage not found';
                return;
            }

            currentStageDisplay.textContent = `${stage.emoji} ${stage.name}`;
            const stageIndex = stageOrder.indexOf(currentStage);
            const progress = (stageIndex / (stageOrder.length - 1)) * 100;
            stageProgress.style.width = `${progress}%`;
            
            // Update stage duration
            stageDurationDisplay.textContent = stage.duration;
            
            // Update conditions
            updateStageConditions();
            
            // Update stages overview
            updateStagesOverview();
        }

        function updateStageConditions() {
            stageConditions.innerHTML = '';
            const stage = plantStages[currentStage];
            
            // Get AI verified conditions from database
            const aiVerifiedConditions = currentCrop.stages && currentCrop.stages[currentStage] 
                ? currentCrop.stages[currentStage].ai_verified_conditions || []
                : Array(stage.conditions.length).fill(false);
            
            stage.conditions.forEach((condition, index) => {
                const isVerified = aiVerifiedConditions[index] || false;
                
                const conditionItem = document.createElement('div');
                conditionItem.className = 'condition-item';
                
                conditionItem.innerHTML = `
                    <div class="condition-status ${isVerified ? 'condition-met' : 'condition-pending'}">
                        <i class="fas fa-${isVerified ? 'check' : 'clock'}"></i>
                    </div>
                    <div class="condition-text">
                        ${condition}
                        ${!isVerified ? `<div class="ai-verification-status ai-pending" style="margin-top: 8px;">
                            <i class="fas fa-robot"></i> AI verification pending
                        </div>` : ''}
                    </div>
                `;
                
                stageConditions.appendChild(conditionItem);
            });
            
            // Show next steps if there are pending conditions
            const allConditionsVerified = aiVerifiedConditions.length === stage.conditions.length && 
                                        aiVerifiedConditions.every(condition => condition === true);
            
            if (!allConditionsVerified) {
                showNextSteps();
            } else {
                hideNextSteps();
                // Automatically advance to next stage if all conditions are verified
                autoAdvanceStage();
            }
        }

        // Show next steps for current stage
        function showNextSteps() {
            const stage = plantStages[currentStage];
            nextStepsList.innerHTML = '';
            
            stage.recommendations.forEach(recommendation => {
                const li = document.createElement('li');
                li.textContent = recommendation;
                nextStepsList.appendChild(li);
            });
            
            nextSteps.style.display = 'block';
        }

        // Hide next steps
        function hideNextSteps() {
            nextSteps.style.display = 'none';
        }

        // Automatically advance to next stage when all conditions are verified
        async function autoAdvanceStage() {
            const currentIndex = stageOrder.indexOf(currentStage);
            if (currentIndex < stageOrder.length - 1) {
                const nextStage = stageOrder[currentIndex + 1];
                
                try {
                    // Update current stage in crops table
                    const { error: cropError } = await window.supabaseClient
                        .from('crops')
                        .update({ 
                            current_stage: nextStage,
                            updated_at: new Date().toISOString()
                        })
                        .eq('crop_id', currentCrop.crop_id);

                    if (cropError) {
                        showError('Crop Stage Update Failed', 'Failed to update crop stage in database.', cropError);
                        return;
                    }

                    // Update crop_stages table
                    await window.supabaseClient
                        .from('crop_stages')
                        .update({ 
                            is_current: false,
                            updated_at: new Date().toISOString()
                        })
                        .eq('crop_id', currentCrop.crop_id)
                        .eq('stage_key', currentStage);

                    await window.supabaseClient
                        .from('crop_stages')
                        .update({ 
                            is_current: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('crop_id', currentCrop.crop_id)
                        .eq('stage_key', nextStage);

                    // Update local state
                    currentStage = nextStage;
                    currentCrop.current_stage = nextStage;
                    
                    // Update landCrops data
                    const landId = userLands[currentLandIndex].land_id;
                    const cropIndex = landCrops[landId].findIndex(crop => crop.crop_id === currentCrop.crop_id);
                    if (cropIndex !== -1) {
                        landCrops[landId][cropIndex].current_stage = nextStage;
                    }
                    
                    updateStageDisplay();
                    showNotification(`Crop automatically advanced to ${plantStages[nextStage].name}!`);

                } catch (error) {
                    showError('Stage Advancement Failed', 'Failed to advance to next stage.', error);
                }
            }
        }

        function updateStagesOverview() {
            stagesOverview.innerHTML = '';
            const currentIndex = stageOrder.indexOf(currentStage);
            
            stageOrder.forEach((stageKey, index) => {
                const stage = plantStages[stageKey];
                const isCompleted = index < currentIndex;
                const isActive = index === currentIndex;
                
                const stageIndicator = document.createElement('div');
                stageIndicator.className = `stage-indicator ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
                stageIndicator.setAttribute('data-stage', stageKey);
                
                stageIndicator.innerHTML = `
                    <div class="stage-emoji">${stage.emoji}</div>
                    <div class="stage-name-short">${stage.name.split(' ')[0]}</div>
                `;
                
                // Only allow viewing completed or current stages (no navigation)
                if (index <= currentIndex) {
                    stageIndicator.style.cursor = 'pointer';
                    stageIndicator.addEventListener('click', () => {
                        currentStage = stageKey;
                        updateStageDisplay();
                    });
                } else {
                    stageIndicator.style.cursor = 'default';
                    stageIndicator.style.opacity = '0.5';
                }
                
                stagesOverview.appendChild(stageIndicator);
            });
        }

        // Start crop journey
        async function startCropJourney() {
            const cropName = cropNameInput.value.trim();
            
            if (!cropName) {
                showError('Input Required', 'Please enter a crop name.');
                return;
            }
            
            if (userLands.length === 0) {
                showError('No Lands Available', 'No land available. Please add a land first.');
                return;
            }
            
            const currentLand = userLands[currentLandIndex];
            
            try {
                // Create a new crop
                const cropId = 'CROP_' + Date.now();
                const plantingDate = new Date().toISOString().split('T')[0];
                
                // Calculate expected harvest date (add 120 days as default)
                const harvestDate = new Date();
                harvestDate.setDate(harvestDate.getDate() + 120);
                const expectedHarvestDate = harvestDate.toISOString().split('T')[0];
                
                // Insert crop into database
                const { data: crop, error } = await window.supabaseClient
                    .from('crops')
                    .insert({
                        crop_id: cropId,
                        auth_id: currentUser.id,
                        land_id: currentLand.land_id,
                        crop_name: cropName,
                        crop_type: 'custom',
                        planting_date: plantingDate,
                        expected_harvest_date: expectedHarvestDate,
                        area_allocated: currentLand.area_acres,
                        current_stage: 'germination',
                        is_active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (error) {
                    showError('Crop Creation Failed', 'Failed to create crop in database.', error);
                    return;
                }
                
                // Create crop stages with empty AI verification
                for (let i = 0; i < stageOrder.length; i++) {
                    const stageKey = stageOrder[i];
                    const stage = plantStages[stageKey];
                    
                    const { error: stageError } = await window.supabaseClient
                        .from('crop_stages')
                        .insert({
                            crop_id: cropId,
                            auth_id: currentUser.id,
                            stage_key: stageKey,
                            stage_name: stage.name,
                            stage_order: i,
                            ai_verified_conditions: Array(stage.conditions.length).fill(false),
                            is_current: i === 0,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    
                    if (stageError) {
                        console.error('Error creating stage:', stageError);
                    }
                }
                
                // Update local state
                currentCrop = crop;
                currentCrop.stages = {};
                
                // Initialize stages in local state
                for (let stageKey of stageOrder) {
                    currentCrop.stages[stageKey] = {
                        ai_verified_conditions: Array(plantStages[stageKey].conditions.length).fill(false)
                    };
                }
                
                // Update landCrops
                if (!landCrops[currentLand.land_id]) {
                    landCrops[currentLand.land_id] = [];
                }
                landCrops[currentLand.land_id].push(currentCrop);
                
                // Update UI
                updateCropDisplay();
                showNotification(`Crop journey started for ${cropName}!`);
                
                // Clear input
                cropNameInput.value = '';
                startJourneyBtn.disabled = true;
                
            } catch (error) {
                showError('Crop Journey Start Failed', 'Failed to start crop journey.', error);
            }
        }

        // Navigate to stage identification page
        function navigateToStageIdentification() {
            if (!currentCrop) {
                showError('No Crop Selected', 'Please select a crop first.');
                return;
            }
            
            // Store current crop info in session storage for stage.html
            sessionStorage.setItem('currentCropId', currentCrop.crop_id);
            sessionStorage.setItem('currentCropName', currentCrop.crop_name);
            sessionStorage.setItem('currentStage', currentStage);
            sessionStorage.setItem('currentLandId', userLands[currentLandIndex].land_id);
            sessionStorage.setItem('currentLandName', userLands[currentLandIndex].land_name);
            
            // Navigate to stage identification page
            window.location.href = 'stage.html';
        }

        // Helper function to show notifications
        function showNotification(message) {
            // Create a simple notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary);
                color: white;
                padding: 12px 20px;
                border-radius: var(--radius);
                box-shadow: var(--shadow-hover);
                z-index: 10000;
                max-width: 300px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Event Listeners
        function setupEventListeners() {
            // Land navigation
            prevLandBtn.addEventListener('click', () => {
                if (currentLandIndex > 0) {
                    currentLandIndex--;
                    updateLandDisplay();
                }
            });

            nextLandBtn.addEventListener('click', () => {
                if (currentLandIndex < userLands.length - 1) {
                    currentLandIndex++;
                    updateLandDisplay();
                }
            });

            // Crop input
            cropNameInput.addEventListener('input', () => {
                startJourneyBtn.disabled = !cropNameInput.value.trim();
            });

            startJourneyBtn.addEventListener('click', startCropJourney);

            // Update stage button
            updateStageBtn.addEventListener('click', navigateToStageIdentification);

            // Error display close
            errorDisplay.addEventListener('click', hideError);
        }

        // Initialize the application
        async function initApp() {
            try {
                // Set up event listeners
                setupEventListeners();
                
                // Initialize map
                initializeMap();
                
                // Get user location
                getUserLocation();
                
                // Load user data
                await loadUserData();
                
            } catch (error) {
                showError('App Initialization Failed', 'Failed to initialize the application.', error);
            }
        }

        // Start the application
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
