<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farm Market Price Viewer</title>
  <style>
    :root {
      --primary: #2e7d32;
      --primary-light: #4caf50;
      --primary-dark: #1b5e20;
      --secondary: #ff9800;
      --light: #f8f9fa;
      --dark: #333;
      --gray: #6c757d;
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f2f7f2 0%, #e8f5e9 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(to right, var(--primary), var(--primary-light));
      color: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    
    header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    header p {
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .search-container {
      background: white;
      padding: 25px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }
    
    .search-box {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: end;
    }
    
    .form-group {
      flex: 1;
      min-width: 200px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--dark);
    }
    
    input, select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      font-size: 16px;
      transition: all 0.3s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    
    .location-group {
      display: flex;
      gap: 10px;
    }
    
    .location-group input {
      flex: 1;
    }
    
    .location-btn {
      padding: 12px;
      background: var(--secondary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .location-btn:hover {
      background: #e68900;
    }
    
    .location-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .location-loading {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    button {
      padding: 12px 25px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .results-container {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .results-header {
      padding: 15px 20px;
      background: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .results-count {
      font-weight: 600;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th {
      background: #f5f5f5;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: var(--dark);
      border-bottom: 1px solid #ddd;
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }
    
    tr:hover {
      background: #f9f9f9;
    }
    
    .no-results {
      padding: 40px;
      text-align: center;
      color: var(--gray);
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 15px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(76, 175, 80, 0.2);
      border-left: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error {
      padding: 20px;
      background: #ffebee;
      color: #c62828;
      border-radius: var(--radius);
      margin: 20px 0;
      text-align: center;
    }
    
    .location-notice {
      padding: 15px;
      background: #e3f2fd;
      color: #1565c0;
      border-radius: var(--radius);
      margin: 15px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    footer {
      text-align: center;
      margin-top: 40px;
      padding: 20px;
      color: var(--gray);
      font-size: 0.9rem;
    }
    
    .commodity-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .commodity-btn {
      padding: 8px 16px;
      background: #e8f5e9;
      color: var(--primary-dark);
      border: 1px solid var(--primary-light);
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .commodity-btn:hover {
      background: var(--primary-light);
      color: white;
    }
    
    .commodity-btn.active {
      background: var(--primary);
      color: white;
    }
    
    .regional-prices {
      margin: 30px 0;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    
    .regional-header {
      padding: 15px 20px;
      background: var(--primary);
      color: white;
    }
    
    .regional-content {
      padding: 20px;
    }
    
    .regional-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .regional-card {
      border: 1px solid #eee;
      border-radius: var(--radius);
      padding: 15px;
      background: #f9f9f9;
    }
    
    .regional-card h3 {
      color: var(--primary-dark);
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #ddd;
    }
    
    .regional-card ul {
      list-style-type: none;
    }
    
    .regional-card li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px dashed #eee;
    }
    
    .regional-card li:last-child {
      border-bottom: none;
    }
    
    .crop-name {
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .crop-price {
      color: var(--primary);
      font-weight: 600;
    }
    
    .crop-region {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 2px;
    }
    
    @media (max-width: 768px) {
      .search-box {
        flex-direction: column;
      }
      
      .form-group {
        min-width: 100%;
      }
      
      header h1 {
        font-size: 2rem;
      }
      
      th, td {
        padding: 10px;
      }
      
      .regional-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üåæ Farm Market Price Viewer</h1>
      <p>Get real-time market prices for agricultural commodities based on your location</p>
    </header>
    
    <div class="search-container">
      <div class="search-box">
        <div class="form-group">
          <label for="commodity">Commodity</label>
          <input type="text" id="commodity" placeholder="e.g. Wheat, Rice, Cotton">
          <div class="commodity-buttons">
            <button class="commodity-btn" data-commodity="Wheat">Wheat</button>
            <button class="commodity-btn" data-commodity="Rice">Rice</button>
            <button class="commodity-btn" data-commodity="Cotton">Cotton</button>
            <button class="commodity-btn" data-commodity="Maize">Maize</button>
            <button class="commodity-btn" data-commodity="Soyabean">Soyabean</button>
            <button class="commodity-btn" data-commodity="Chana">Chana</button>
          </div>
        </div>
        
        <div class="form-group">
          <label for="district">District (Optional)</label>
          <div class="location-group">
            <input type="text" id="district" placeholder="e.g. Pune, Guntur">
            <button class="location-btn" id="location-btn" title="Detect my location">
              üìç
            </button>
          </div>
        </div>
        
        <button onclick="fetchPrices()">
          <span>üîç</span> Search Prices
        </button>
      </div>
    </div>
    
    <div class="regional-prices">
      <div class="regional-header">
        <h2>üí∞ Popular Crops in Your Region</h2>
      </div>
      <div class="regional-content">
        <div class="loading" id="regional-loading">
          <div class="spinner"></div>
          <p>Fetching crop prices for your location...</p>
        </div>
        <div class="regional-grid" id="regional-grid" style="display: none;">
          <!-- Regional crop prices will be populated here -->
        </div>
      </div>
    </div>
    
    <div class="results-container" id="results">
      <div class="results-header">
        <h2>Market Prices</h2>
        <div class="results-count" id="results-count">No results yet</div>
      </div>
      
      <div class="table-container">
        <div class="no-results" id="no-results">
          Enter a commodity name and click "Search Prices" to view market data
        </div>
      </div>
    </div>
    
    <footer>
      <p>Data provided by Government of India | Farm Market Price Viewer ¬© 2023</p>
    </footer>
  </div>

  <script>
    // DOM elements
    const commodityInput = document.getElementById('commodity');
    const districtInput = document.getElementById('district');
    const locationBtn = document.getElementById('location-btn');
    const resultsDiv = document.getElementById('results');
    const tableContainer = document.querySelector('.table-container');
    const noResultsDiv = document.getElementById('no-results');
    const resultsCount = document.getElementById('results-count');
    const commodityButtons = document.querySelectorAll('.commodity-btn');
    const regionalGrid = document.getElementById('regional-grid');
    const regionalLoading = document.getElementById('regional-loading');
    
    // Common crops for the region
    const commonCrops = ['Wheat', 'Rice', 'Cotton', 'Maize', 'Soyabean', 'Chana', 'Tomato', 'Potato'];
    
    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      // Set default commodity to Wheat
      commodityInput.value = 'Wheat';
      
      // Add event listeners to commodity buttons
      commodityButtons.forEach(button => {
        button.addEventListener('click', function() {
          const commodity = this.getAttribute('data-commodity');
          commodityInput.value = commodity;
          
          // Update active state
          commodityButtons.forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          
          // Fetch prices for the selected commodity
          fetchPrices();
        });
      });
      
      // Set Wheat as active by default
      document.querySelector('.commodity-btn[data-commodity="Wheat"]').classList.add('active');
      
      // Automatically detect location when page loads
      getLocation();
    });
    
    // Location detection function
    function getLocation() {
      locationBtn.classList.add('location-loading');
      locationBtn.disabled = true;
      
      if (!navigator.geolocation) {
        showLocationError("Geolocation is not supported by this browser.");
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        // Success callback
        async (position) => {
          try {
            const { latitude, longitude } = position.coords;
            
            // Use a reverse geocoding service to get district from coordinates
            const district = await reverseGeocode(latitude, longitude);
            
            if (district) {
              districtInput.value = district;
              showLocationNotice(`Location detected: ${district}. Fetching crop prices for your region...`);
              
              // After location is detected, fetch prices for common crops in that region
              fetchRegionalPrices(district);
              
              // Also fetch prices for default commodity (Wheat)
              fetchPrices();
            } else {
              showLocationError("Could not determine district from your location.");
              locationBtn.classList.remove('location-loading');
              locationBtn.disabled = false;
            }
          } catch (error) {
            console.error("Geocoding error:", error);
            showLocationError("Error detecting your location. Please enter district manually.");
            locationBtn.classList.remove('location-loading');
            locationBtn.disabled = false;
          }
        },
        // Error callback
        (error) => {
          locationBtn.classList.remove('location-loading');
          locationBtn.disabled = false;
          
          switch(error.code) {
            case error.PERMISSION_DENIED:
              showLocationError("Location access denied. Please allow location access or enter district manually.");
              break;
            case error.POSITION_UNAVAILABLE:
              showLocationError("Location information unavailable. Please enter district manually.");
              break;
            case error.TIMEOUT:
              showLocationError("Location request timed out. Please try again or enter district manually.");
              break;
            default:
              showLocationError("An unknown error occurred. Please enter district manually.");
          }
        },
        // Options
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }
    
    // Simple reverse geocoding function using OpenStreetMap Nominatim API
    async function reverseGeocode(lat, lng) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`);
        const data = await response.json();
        
        if (data && data.address) {
          // Try to get district, county, or state based on what's available
          return data.address.district || data.address.county || data.address.state || 'Unknown Location';
        }
        return null;
      } catch (error) {
        console.error("Reverse geocoding error:", error);
        // Fallback to mock data if API fails
        const mockDistricts = [
          "Pune", "Guntur", "Bangalore", "Hyderabad", "Mumbai", 
          "Delhi", "Chennai", "Kolkata", "Ahmedabad", "Jaipur"
        ];
        return mockDistricts[Math.floor(Math.random() * mockDistricts.length)];
      }
    }
    
    // Fetch prices for common crops in the detected region
    async function fetchRegionalPrices(district) {
      try {
        regionalLoading.style.display = 'flex';
        regionalGrid.style.display = 'none';
        
        let regionalHTML = '';
        let cropsFetched = 0;
        const maxCrops = 8;
        
        // Fetch prices for each common crop
        for (const crop of commonCrops) {
          if (cropsFetched >= maxCrops) break;
          
          try {
            const apiKey = "579b464db66ec23bdd0000019698a7ba4a9742a061ac559bd03294af";
            const url = `https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${apiKey}&format=json&limit=5&filters[commodity]=${crop}&filters[district]=${district}`;
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.records && data.records.length > 0) {
              const record = data.records[0];
              const price = record.min_price || record.max_price || 'N/A';
              
              regionalHTML += `
                <div class="regional-card">
                  <h3>${getCropEmoji(crop)} ${crop}</h3>
                  <ul>
                    <li>
                      <div class="crop-name">${crop}</div>
                      <div class="crop-price">‚Çπ${price}/q</div>
                      <div class="crop-region">${district}</div>
                    </li>
                  </ul>
                </div>
              `;
              
              cropsFetched++;
            }
          } catch (error) {
            console.error(`Error fetching price for ${crop}:`, error);
          }
        }
        
        if (cropsFetched > 0) {
          regionalGrid.innerHTML = regionalHTML;
          regionalLoading.style.display = 'none';
          regionalGrid.style.display = 'grid';
        } else {
          regionalLoading.innerHTML = `
            <div class="no-results">
              <h3>No regional data available</h3>
              <p>Could not fetch crop prices for your location. Try searching for specific crops.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error("Error fetching regional prices:", error);
        regionalLoading.innerHTML = `
          <div class="error">
            <h3>Error fetching regional data</h3>
            <p>There was a problem retrieving crop prices for your region.</p>
          </div>
        `;
      }
    }
    
    // Get emoji for crop
    function getCropEmoji(crop) {
      const emojiMap = {
        'Wheat': 'üåæ',
        'Rice': 'üçö',
        'Cotton': 'üßµ',
        'Maize': 'üåΩ',
        'Soyabean': 'ü´ò',
        'Chana': 'ü´ò',
        'Tomato': 'üçÖ',
        'Potato': 'ü•î'
      };
      return emojiMap[crop] || 'üå±';
    }
    
    // Show location notice
    function showLocationNotice(message) {
      // Remove any existing notices
      const existingNotice = document.querySelector('.location-notice');
      if (existingNotice) {
        existingNotice.remove();
      }
      
      const notice = document.createElement('div');
      notice.className = 'location-notice';
      notice.innerHTML = `
        <span>‚ÑπÔ∏è</span>
        <span>${message}</span>
      `;
      
      document.querySelector('.search-container').appendChild(notice);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (notice.parentNode) {
          notice.remove();
        }
      }, 5000);
    }
    
    // Show location error
    function showLocationError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.innerHTML = `
        <h3>Location Error</h3>
        <p>${message}</p>
      `;
      
      document.querySelector('.search-container').appendChild(errorDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.remove();
        }
      }, 5000);
    }
    
    // Fetch market prices
    async function fetchPrices() {
      const commodity = commodityInput.value.trim();
      const district = districtInput.value.trim();
      
      // Clear previous results
      noResultsDiv.style.display = 'none';
      
      if (!commodity) {
        resultsDiv.innerHTML = `
          <div class="results-header">
            <h2>Market Prices</h2>
            <div class="results-count">Error</div>
          </div>
          <div class="error">Please enter a commodity name.</div>
        `;
        return;
      }
      
      // Show loading state
      tableContainer.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Fetching market prices for ${commodity}${district ? ` in ${district}` : ''}...</p>
        </div>
      `;
      
      const apiKey = "579b464db66ec23bdd0000019698a7ba4a9742a061ac559bd03294af";
      let url = `https://api.data.gov.in/resource/9ef84268-d588-465a-a308-a864a43d0070?api-key=${apiKey}&format=json&limit=50&filters[commodity]=${commodity}`;
      
      if (district) {
        url += `&filters[district]=${district}`;
      }
      
      try {
        const response = await fetch(url);
        const data = await response.json();
        const records = data.records;
        
        if (!records || records.length === 0) {
          tableContainer.innerHTML = `
            <div class="no-results">
              <h3>No data found</h3>
              <p>No market prices found for "${commodity}"${district ? ` in district "${district}"` : ''}.</p>
              <p>Try a different commodity name or check the spelling.</p>
            </div>
          `;
          resultsCount.textContent = "0 results";
          return;
        }
        
        // Create table with results
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>Market</th>
                <th>District</th>
                <th>Commodity</th>
                <th>Variety</th>
                <th>Min Price (‚Çπ)</th>
                <th>Max Price (‚Çπ)</th>
                <th>Arrival Date</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        records.forEach(r => {
          tableHTML += `
            <tr>
              <td>${r.market || '-'}</td>
              <td>${r.district || '-'}</td>
              <td>${r.commodity || '-'}</td>
              <td>${r.variety || '-'}</td>
              <td>‚Çπ${r.min_price || 'N/A'}</td>
              <td>‚Çπ${r.max_price || 'N/A'}</td>
              <td>${r.arrival_date || '-'}</td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        tableContainer.innerHTML = tableHTML;
        resultsCount.textContent = `${records.length} results found`;
        
      } catch (error) {
        tableContainer.innerHTML = `
          <div class="error">
            <h3>Error fetching data</h3>
            <p>There was a problem retrieving market prices. Please try again later.</p>
            <p>If the problem persists, check your internet connection.</p>
          </div>
        `;
        resultsCount.textContent = "Error";
        console.error(error);
      }
    }
    
    // Event listeners
    locationBtn.addEventListener('click', getLocation);
    
    commodityInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        fetchPrices();
      }
    });
    
    districtInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        fetchPrices();
      }
    });
  </script>
</body>
</html>
