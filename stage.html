<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Growth Stage Identifier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            color: #2e7d32;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #1b5e20;
        }
        
        .description {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: #388e3c;
            line-height: 1.6;
        }
        
        .crop-info {
            background: #f1f8e9;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: left;
        }
        
        .crop-info h3 {
            color: #1b5e20;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .crop-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .crop-detail {
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .crop-detail-label {
            font-weight: 600;
            color: #2e7d32;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .crop-detail-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1b5e20;
        }
        
        .upload-container {
            border: 3px dashed #81c784;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            background-color: #f1f8e9;
            cursor: pointer;
        }
        
        .upload-container:hover {
            border-color: #4caf50;
            background-color: #e8f5e9;
        }
        
        .upload-container.dragover {
            border-color: #2e7d32;
            background-color: #c8e6c9;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #66bb6a;
            margin-bottom: 1rem;
        }
        
        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .browse-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .browse-btn:hover {
            background-color: #388e3c;
        }
        
        #file-input {
            display: none;
        }
        
        .image-preview {
            margin: 2rem 0;
            display: none;
        }
        
        .preview-img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .identify-btn {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 2rem;
            display: none;
        }
        
        .identify-btn:hover {
            background-color: #f57c00;
        }
        
        .identify-btn:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }
        
        .stage-indicator {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
        }
        
        .stage {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e0e0;
            color: #757575;
            font-weight: bold;
            position: relative;
            z-index: 2;
            font-size: 1.5rem;
        }
        
        .stage.active {
            background-color: #4caf50;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.3);
        }
        
        .stage-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background-color: #e0e0e0;
            transform: translateY(-50%);
            z-index: 1;
        }
        
        .stage-label {
            position: absolute;
            top: 70px;
            font-size: 0.8rem;
            text-align: center;
            width: 100px;
            left: -20px;
            font-weight: 500;
        }
        
        .result-container {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            border-radius: 15px;
            background-color: #e8f5e9;
            text-align: left;
        }
        
        .result-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #1b5e20;
            text-align: center;
        }
        
        .stage-info {
            background-color: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .stage-name {
            font-size: 1.3rem;
            color: #2e7d32;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stage-duration {
            font-size: 0.9rem;
            color: #757575;
            margin-bottom: 1rem;
            font-style: italic;
        }
        
        .stage-description {
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .conditions-list, .recommendations-list {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        
        .conditions-list li, .recommendations-list li {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        .section-title {
            font-weight: 600;
            color: #1b5e20;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .loading {
            display: none;
            margin: 2rem 0;
        }
        
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4caf50;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
        }
        
        .success-message {
            color: #1b5e20;
            background-color: #e8f5e9;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: none;
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .confirm-btn {
            background-color: #4caf50;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
        }
        
        .confirm-btn:hover {
            background-color: #388e3c;
        }
        
        .retake-btn {
            background-color: #ff9800;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
        }
        
        .retake-btn:hover {
            background-color: #f57c00;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .upload-container {
                padding: 1.5rem;
            }
            
            .stage-label {
                font-size: 0.7rem;
                width: 80px;
                left: -10px;
            }
            
            .stage {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .crop-details {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üå± Plant Growth Stage Identifier</h1>
        <p class="description">Upload an image of your plant and our AI will identify its current growth stage and provide care recommendations.</p>
        
        <!-- Crop Information -->
        <div class="crop-info" id="cropInfo">
            <h3><i class="fas fa-seedling"></i> Current Crop Information</h3>
            <div class="crop-details">
                <div class="crop-detail">
                    <div class="crop-detail-label">Crop Name</div>
                    <div class="crop-detail-value" id="currentCropName">Loading...</div>
                </div>
                <div class="crop-detail">
                    <div class="crop-detail-label">Land</div>
                    <div class="crop-detail-value" id="currentLandName">Loading...</div>
                </div>
                <div class="crop-detail">
                    <div class="crop-detail-label">Current Stage</div>
                    <div class="crop-detail-value" id="currentStage">Loading...</div>
                </div>
                <div class="crop-detail">
                    <div class="crop-detail-label">Planting Date</div>
                    <div class="crop-detail-value" id="plantingDate">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="upload-container" id="upload-area">
            <div class="upload-icon">üìÅ</div>
            <p class="upload-text">Drag & drop your plant image here</p>
            <p class="upload-text">or</p>
            <button class="browse-btn">Browse Files</button>
            <input type="file" id="file-input" accept="image/*">
        </div>
        
        <div class="image-preview" id="image-preview">
            <img class="preview-img" id="preview-img" src="" alt="Plant Image Preview">
        </div>
        
        <button class="identify-btn" id="identify-btn" disabled>Identify Plant Stage</button>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Analyzing your plant image...</p>
        </div>
        
        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>
        
        <div class="stage-indicator">
            <div class="stage-line"></div>
            <div class="stage" id="stage-seed">
                üå±
                <div class="stage-label">Germination</div>
            </div>
            <div class="stage" id="stage-seedling">
                üåø
                <div class="stage-label">Seedling</div>
            </div>
            <div class="stage" id="stage-vegetative">
                üåæ
                <div class="stage-label">Vegetative</div>
            </div>
            <div class="stage" id="stage-flowering">
                üå∏
                <div class="stage-label">Flowering</div>
            </div>
            <div class="stage" id="stage-fruiting">
                üçÖ
                <div class="stage-label">Fruiting</div>
            </div>
            <div class="stage" id="stage-maturity">
                üåª
                <div class="stage-label">Maturity</div>
            </div>
        </div>
        
        <div class="result-container" id="result-container">
            <h2 class="result-title">Plant Analysis Result</h2>
            <div class="result-content" id="result-content"></div>
            
            <div class="action-buttons">
                <button class="confirm-btn" id="confirm-btn">Confirm & Save Analysis</button>
                <button class="retake-btn" id="retake-btn">Retake Photo</button>
            </div>
        </div>
    </div>

    <!-- Include Font Awesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <!-- Include Supabase and auth scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
    <script src="auth-checker.js"></script>

    <script>
        // DOM elements
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const previewImg = document.getElementById('preview-img');
        const imagePreview = document.getElementById('image-preview');
        const identifyBtn = document.getElementById('identify-btn');
        const loading = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');
        const resultContent = document.getElementById('result-content');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        const confirmBtn = document.getElementById('confirm-btn');
        const retakeBtn = document.getElementById('retake-btn');
        
        // Crop info elements
        const currentCropName = document.getElementById('currentCropName');
        const currentLandName = document.getElementById('currentLandName');
        const currentStage = document.getElementById('currentStage');
        const plantingDate = document.getElementById('plantingDate');
        
        // Stage indicators
        const stageSeed = document.getElementById('stage-seed');
        const stageSeedling = document.getElementById('stage-seedling');
        const stageVegetative = document.getElementById('stage-vegetative');
        const stageFlowering = document.getElementById('stage-flowering');
        const stageFruiting = document.getElementById('stage-fruiting');
        const stageMaturity = document.getElementById('stage-maturity');
        
        // Global variables
        let currentUser = null;
        let currentCrop = null;
        let currentLand = null;
        let currentAnalysis = null;
        let selectedFile = null;
        
        // Plant stage data
        const plantStages = {
            germination: {
                name: "Germination (Seed Stage)",
                emoji: "üå±",
                duration: "Few days to 2 weeks",
                description: "The seed absorbs water and swells. The embryo inside starts to grow. The root (radicle) comes out first, followed by the shoot.",
                conditions: [
                    "Adequate moisture",
                    "Suitable temperature (20-25¬∞C)",
                    "Proper soil depth"
                ],
                recommendations: [
                    "Maintain consistent soil moisture but avoid overwatering",
                    "Keep soil temperature between 20-25¬∞C for optimal germination",
                    "Ensure proper seed depth according to crop type"
                ],
                durationDays: 14
            },
            seedling: {
                name: "Seedling Stage",
                emoji: "üåø",
                duration: "1‚Äì4 weeks",
                description: "The young plant develops its first true leaves. Roots grow deeper to absorb nutrients and water. The plant is delicate and needs proper care.",
                conditions: [
                    "Adequate light (12-16 hours daily)",
                    "Regular watering",
                    "Nutrient availability",
                    "Protection from pests"
                ],
                recommendations: [
                    "Provide adequate light for strong growth",
                    "Apply balanced, diluted fertilizer",
                    "Monitor for pests and diseases",
                    "Maintain consistent soil moisture"
                ],
                durationDays: 28
            },
            vegetative: {
                name: "Vegetative Growth Stage",
                emoji: "üåæ",
                duration: "Several weeks to months",
                description: "Rapid growth phase ‚Äî plant produces more leaves, stems, and roots. Focus is on building a strong structure for future flowering and fruiting.",
                conditions: [
                    "Adequate space between plants",
                    "Balanced nutrition",
                    "Proper pruning",
                    "Weed control",
                    "Adequate water supply"
                ],
                recommendations: [
                    "Increase nitrogen-rich fertilizer for leaf growth",
                    "Ensure proper spacing for air circulation",
                    "Implement weed control measures",
                    "Monitor for nutrient deficiencies"
                ],
                durationDays: 56
            },
            flowering: {
                name: "Flowering or Reproductive Stage",
                emoji: "üå∏",
                duration: "1‚Äì4 weeks typically",
                description: "The plant begins to produce flowers or reproductive parts. Pollination occurs (by wind, insects, or manually).",
                conditions: [
                    "Proper pollination",
                    "Adequate light",
                    "Proper temperature",
                    "Reduced nitrogen",
                    "Increased phosphorus"
                ],
                recommendations: [
                    "Reduce nitrogen and increase phosphorus for flowering",
                    "Ensure pollinators have access",
                    "Consider manual pollination if needed",
                    "Maintain optimal temperature range"
                ],
                durationDays: 28
            },
            fruiting: {
                name: "Fruiting or Grain Filling Stage",
                emoji: "üçÖ",
                duration: "Varies widely (from weeks to months)",
                description: "After successful pollination, fruits or grains start developing. Nutrients and energy are directed toward filling seeds or fruits.",
                conditions: [
                    "Adequate water supply",
                    "Nutrient availability",
                    "Pest control",
                    "Disease management",
                    "Proper support for heavy fruits"
                ],
                recommendations: [
                    "Apply potassium-rich fertilizer for fruit development",
                    "Maintain consistent watering",
                    "Implement pest control measures",
                    "Provide support for heavy fruiting plants"
                ],
                durationDays: 42
            },
            maturity: {
                name: "Maturity and Harvesting Stage",
                emoji: "üåª",
                duration: "Varies by crop",
                description: "Fruits, grains, or pods reach full size and ripen. Moisture levels drop, and the plant may begin to dry or turn yellow. Crops are ready for harvest.",
                conditions: [
                    "Proper harvest timing",
                    "Dry weather for harvesting",
                    "Storage preparation",
                    "Quality assessment"
                ],
                recommendations: [
                    "Reduce watering as harvest approaches",
                    "Monitor for optimal harvest time",
                    "Prepare storage facilities",
                    "Check crop quality before harvest"
                ],
                durationDays: 14
            }
        };
        
        // API configuration
        const API_KEY = 'AIzaSyD-qhnQlGDMd2BcoZo-hv5ld2fbDzP49sI';
        const API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent';
        
        // Initialize the application
        async function initApp() {
            try {
                // Check authentication
                const isAuthenticated = await window.authChecker.requireAuth();
                if (!isAuthenticated) return;
                
                // Get current user
                currentUser = await window.authChecker.getCurrentUser();
                if (!currentUser) {
                    showError('User not found. Please log in again.');
                    return;
                }
                
                // Load current crop data from session storage
                await loadCurrentCropData();
                
                // Set up event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Error initializing app:', error);
                showError('Failed to initialize application. Please refresh the page.');
            }
        }
        
        // Load current crop data from session storage
        async function loadCurrentCropData() {
            try {
                const cropId = sessionStorage.getItem('currentCropId');
                const landId = sessionStorage.getItem('currentLandId');
                
                if (!cropId || !landId) {
                    showError('No crop selected. Please go back to crops page and select a crop.');
                    return;
                }
                
                // Load crop data from Supabase
                const { data: crop, error: cropError } = await window.supabaseClient
                    .from('crops')
                    .select('*')
                    .eq('crop_id', cropId)
                    .eq('auth_id', currentUser.id)
                    .single();
                
                if (cropError) {
                    showError('Failed to load crop data: ' + cropError.message);
                    return;
                }
                
                // Load land data
                const { data: land, error: landError } = await window.supabaseClient
                    .from('lands')
                    .select('land_name')
                    .eq('land_id', landId)
                    .eq('auth_id', currentUser.id)
                    .single();
                
                if (landError) {
                    showError('Failed to load land data: ' + landError.message);
                    return;
                }
                
                currentCrop = crop;
                currentLand = land;
                
                // Update UI with crop information
                updateCropInfoUI();
                
            } catch (error) {
                console.error('Error loading crop data:', error);
                showError('Failed to load crop data. Please try again.');
            }
        }
        
        // Update crop information UI
        function updateCropInfoUI() {
            if (!currentCrop || !currentLand) return;
            
            currentCropName.textContent = currentCrop.crop_name;
            currentLandName.textContent = currentLand.land_name;
            
            const stageData = plantStages[currentCrop.current_stage] || plantStages.germination;
            currentStage.textContent = stageData.name;
            
            if (currentCrop.planting_date) {
                const plantingDateObj = new Date(currentCrop.planting_date);
                plantingDate.textContent = plantingDateObj.toLocaleDateString();
            } else {
                plantingDate.textContent = 'Not set';
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileSelection();
                }
            });
            
            fileInput.addEventListener('change', handleFileSelection);
            identifyBtn.addEventListener('click', identifyPlantStage);
            confirmBtn.addEventListener('click', saveAnalysisToDatabase);
            retakeBtn.addEventListener('click', resetAnalysis);
        }
        
        function handleFileSelection() {
            const file = fileInput.files[0];
            selectedFile = file;
            
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showError('Please select a valid image file.');
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showError('Please select an image smaller than 5MB.');
                    return;
                }
                
                // Preview image
                const reader = new FileReader();
                reader.onload = (e) => {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                    identifyBtn.disabled = false;
                    identifyBtn.style.display = 'block';
                    hideError();
                    hideSuccess();
                    resetStages();
                    resultContainer.style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function identifyPlantStage() {
            const file = selectedFile;
            
            if (!file) {
                showError('Please select an image first.');
                return;
            }
            
            if (!currentCrop) {
                showError('No crop selected. Please go back to crops page.');
                return;
            }
            
            // Show loading state
            loading.style.display = 'block';
            identifyBtn.disabled = true;
            hideError();
            hideSuccess();
            resultContainer.style.display = 'none';
            
            try {
                // Convert image to base64
                const base64Image = await fileToBase64(file);
                
                // Prepare the request to Gemini API
                const requestBody = {
                    contents: [
                        {
                            parts: [
                                {
                                    text: `Analyze this plant image and identify its growth stage. The plant is ${currentCrop.crop_name}. Choose only ONE of these stages: germination, seedling, vegetative, flowering, fruiting, or maturity. Provide the following information in your response as JSON format:\n\n{\n  \"identified_stage\": \"stage_key\",\n  \"confidence_score\": 0.85,\n  \"plant_species\": \"species name if identifiable\",\n  \"key_characteristics\": [\"char1\", \"char2\"],\n  \"care_recommendations\": [\"rec1\", \"rec2\"],\n  \"additional_notes\": \"any additional observations\"\n}\n\nPlease respond with only the JSON object.`
                                },
                                {
                                    inline_data: {
                                        mime_type: file.type,
                                        data: base64Image.split(',')[1] // Remove data URL prefix
                                    }
                                }
                            ]
                        }
                    ]
                };
                
                // Make API request
                const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }
                
                const data = await response.json();
                
                // Extract the response text
                const responseText = data.candidates[0].content.parts[0].text;
                
                // Parse the JSON response
                let analysisResult;
                try {
                    // Extract JSON from response (in case there's additional text)
                    const jsonMatch = responseText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        analysisResult = JSON.parse(jsonMatch[0]);
                    } else {
                        analysisResult = JSON.parse(responseText);
                    }
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    // Fallback: try to extract stage from text
                    analysisResult = extractStageFromText(responseText);
                }
                
                // Store analysis result
                currentAnalysis = {
                    ...analysisResult,
                    image_data: base64Image,
                    analysis_date: new Date().toISOString()
                };
                
                // Display the result
                displayResult(analysisResult);
                
                // Update stage indicator based on the response
                updateStageIndicator(analysisResult.identified_stage);
                
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to analyze the plant image. Please try again.');
            } finally {
                // Hide loading state
                loading.style.display = 'none';
                identifyBtn.disabled = false;
            }
        }
        
        function extractStageFromText(text) {
            const lowerText = text.toLowerCase();
            let identifiedStage = 'germination';
            let confidenceScore = 0.7;
            
            if (lowerText.includes('seedling')) {
                identifiedStage = 'seedling';
            } else if (lowerText.includes('vegetative')) {
                identifiedStage = 'vegetative';
            } else if (lowerText.includes('flower') || lowerText.includes('bloom')) {
                identifiedStage = 'flowering';
            } else if (lowerText.includes('fruit') || lowerText.includes('berry')) {
                identifiedStage = 'fruiting';
            } else if (lowerText.includes('mature') || lowerText.includes('ripe') || lowerText.includes('harvest')) {
                identifiedStage = 'maturity';
            }
            
            return {
                identified_stage: identifiedStage,
                confidence_score: confidenceScore,
                plant_species: currentCrop.crop_name,
                key_characteristics: ['Analyzed from image'],
                care_recommendations: ['Follow standard care practices for this stage'],
                additional_notes: 'Analysis completed successfully'
            };
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        function displayResult(analysisResult) {
            const stageData = plantStages[analysisResult.identified_stage] || plantStages.germination;
            
            resultContent.innerHTML = `
                <div class="stage-info">
                    <div class="stage-name">${stageData.emoji} ${stageData.name}</div>
                    <div class="stage-duration">Duration: ${stageData.duration}</div>
                    <div class="stage-duration">Confidence: ${(analysisResult.confidence_score * 100).toFixed(1)}%</div>
                    <div class="stage-description">${stageData.description}</div>
                    
                    <div class="section-title">Identified Characteristics:</div>
                    <ul class="conditions-list">
                        ${(analysisResult.key_characteristics || ['Characteristics identified from image analysis']).map(char => `<li>${char}</li>`).join('')}
                    </ul>
                    
                    <div class="section-title">Ideal Conditions:</div>
                    <ul class="conditions-list">
                        ${stageData.conditions.map(condition => `<li>${condition}</li>`).join('')}
                    </ul>
                    
                    <div class="section-title">AI Care Recommendations:</div>
                    <ul class="recommendations-list">
                        ${(analysisResult.care_recommendations || stageData.recommendations).map(recommendation => `<li>${recommendation}</li>`).join('')}
                    </ul>
                    
                    ${analysisResult.additional_notes ? `
                        <div class="section-title">Additional Notes:</div>
                        <div class="stage-description">${analysisResult.additional_notes}</div>
                    ` : ''}
                </div>
            `;
            
            resultContainer.style.display = 'block';
            
            // Scroll to result
            resultContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateStageIndicator(identifiedStage) {
            // Reset all stages
            resetStages();
            
            // Activate only the identified stage
            switch(identifiedStage) {
                case 'germination':
                    stageSeed.classList.add('active');
                    break;
                case 'seedling':
                    stageSeedling.classList.add('active');
                    break;
                case 'vegetative':
                    stageVegetative.classList.add('active');
                    break;
                case 'flowering':
                    stageFlowering.classList.add('active');
                    break;
                case 'fruiting':
                    stageFruiting.classList.add('active');
                    break;
                case 'maturity':
                    stageMaturity.classList.add('active');
                    break;
            }
        }
        
        async function saveAnalysisToDatabase() {
            if (!currentAnalysis || !currentCrop || !currentUser) {
                showError('No analysis data to save.');
                return;
            }
            
            try {
                // Generate unique analysis ID
                const analysisId = 'ANALYSIS_' + Date.now();
                
                // 1. Save to plant_analysis table
                const { error: analysisError } = await window.supabaseClient
                    .from('plant_analysis')
                    .insert({
                        analysis_id: analysisId,
                        crop_id: currentCrop.crop_id,
                        auth_id: currentUser.id,
                        land_id: sessionStorage.getItem('currentLandId'),
                        image_url: null, // You could upload to Supabase Storage here
                        identified_stage: currentAnalysis.identified_stage,
                        confidence_score: currentAnalysis.confidence_score,
                        ai_analysis: currentAnalysis,
                        analysis_date: currentAnalysis.analysis_date
                    });
                
                if (analysisError) {
                    throw new Error('Failed to save analysis: ' + analysisError.message);
                }
                
                // 2. Update crop_stages table
                const stageKey = currentAnalysis.identified_stage;
                
                // First, set all stages as not current
                await window.supabaseClient
                    .from('crop_stages')
                    .update({ 
                        is_current: false,
                        updated_at: new Date().toISOString()
                    })
                    .eq('crop_id', currentCrop.crop_id);
                
                // Then, update the identified stage as current
                const { error: stageError } = await window.supabaseClient
                    .from('crop_stages')
                    .update({ 
                        is_current: true,
                        identified_date: new Date().toISOString(),
                        ai_confidence_score: currentAnalysis.confidence_score,
                        ai_analysis_result: currentAnalysis,
                        updated_at: new Date().toISOString()
                    })
                    .eq('crop_id', currentCrop.crop_id)
                    .eq('stage_key', stageKey);
                
                if (stageError) {
                    console.error('Error updating crop stage:', stageError);
                    // Continue anyway as the analysis is saved
                }
                
                // 3. Update crops table with current stage
                const { error: cropError } = await window.supabaseClient
                    .from('crops')
                    .update({ 
                        current_stage: stageKey,
                        updated_at: new Date().toISOString()
                    })
                    .eq('crop_id', currentCrop.crop_id);
                
                if (cropError) {
                    console.error('Error updating crop:', cropError);
                    // Continue anyway as the analysis is saved
                }
                
                // Update local state
                currentCrop.current_stage = stageKey;
                updateCropInfoUI();
                
                showSuccess('Analysis saved successfully! Plant stage updated.');
                
                // Redirect back to crops page after 2 seconds
                setTimeout(() => {
                    window.location.href = 'crops.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving analysis:', error);
                showError('Failed to save analysis: ' + error.message);
            }
        }
        
        function resetAnalysis() {
            fileInput.value = '';
            selectedFile = null;
            imagePreview.style.display = 'none';
            identifyBtn.disabled = true;
            identifyBtn.style.display = 'none';
            resultContainer.style.display = 'none';
            resetStages();
            hideError();
            hideSuccess();
        }
        
        function resetStages() {
            stageSeed.classList.remove('active');
            stageSeedling.classList.remove('active');
            stageVegetative.classList.remove('active');
            stageFlowering.classList.remove('active');
            stageFruiting.classList.remove('active');
            stageMaturity.classList.remove('active');
        }
        
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
        
        function hideError() {
            errorMessage.style.display = 'none';
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
        }
        
        function hideSuccess() {
            successMessage.style.display = 'none';
        }
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
